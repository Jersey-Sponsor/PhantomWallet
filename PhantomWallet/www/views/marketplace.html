<h3 class="tab-title" id="main-nft-tab">NFT Marketplace</h3>

<div class="row setup-content martketplace" id="marketplace">
  <div id="sendSpinner" class="loading">Loading&#8230;</div>
    <div class="col-xs-12">
        <div class="col-md-12">

            <div style="text-align:center;" id="main-logo">
              <img src="img/22series-logo-dark.png" alt="" style="width: 20em;">
            </div>
            <div class="col-md-6 center container-sell" style="margin-top: -4em;z-index: 10;">
              <div class="category sell-nft" id="sell-nft" style="opacity:0" onclick="initiateSell()">Sell NFT</div>
              <div class="category buy-nft" id="buy-nft" style="opacity:0" onclick="initiateBuy()">Buy NFT</div>
              <div class="referral-nft" id="sell-nft-tooltip" style="opacity:0;margin-top:1em;">No fees for seller, 2% fees for buyer!<i class="tooltip fas fa-info-circle" style="margin-left:1em;width:1em;" data-tooltip-content="#tooltip_fees"></i></div>
            </div>
            <div class="col-md-6 center container-prize" style="opacity:0;margin-top:-6em;">
              <h3 style="margin-bottom:0;">Total Items</h3>
              <div class="prizepool" style="display:inline-block;" id="prizepool">XXX NFTs</div><i class="tooltip fas fa-info-circle" id="tooltip-stats-container" style="display:none;margin-left:1em;width:1em;vertical-align:super;" data-tooltip-content="#tooltip_stats"></i>
            </div>
            <div class="col-md-12 center nft-cat-headers" style="margin-top:-2em;">
              <div id="current-balances">
                <div id="current-balance-desc" style="display:inline-block;margin-right:1em;">Available</div>
                <div id="current-balance-soul" style="display:inline-block;"><img src="img/soul_logo.png" alt="SOUL" title="Available Balance" style="margin-right:1em;width:2.5em;">XXX SOUL</div>
                <div id="current-balance-kcal" style="display:inline-block;margin-left:1em;"><img src="img/kcal_logo.png" alt="KCAL" title="Available Balance" style="margin-right:1em;width:2.5em;">XXX KCAL</div>
                <div id="current-balance-goati" style="display:inline-block;margin-left:1em;"><img src="img/goati_logo.png" alt="GOATI" title="Available Balance" style="margin-right:1em;width:2.5em;">XXX GOATI</div>
              </div>
              <div class="wrapper-filters" style="opacity:0">
                <div>Filter by</div>
                <div id="nft-category">
                  <div class="category" id="filter-all-items" onclick="filterCategory(this.id)">All items</div>
                  <div class="category" id="filter-my-items" onclick="filterCategory(this.id)"><i class="fas fa-wallet"></i>My items</div>
                  <div class="category" id="filter-game-access" onclick="filterCategory(this.id)"><i class="fas fa-gamepad"></i>Game Access</div>
                  <div class="category" id="filter-vehicle-parts" onclick="filterCategory(this.id)"><i class="fas fa-wrench"></i>Parts</div>
                  <div class="category" id="filter-vehicles" onclick="filterCategory(this.id)"><i class="fas fa-car"></i>Vehicles</div>
                </div>
              </div>
              <div class="wrapper-sorters" style="opacity:0;margin-left:1em;">
                <div>Sort by</div>
                <div id="nft-category">
                  <div class="category sort" id="sort-price" data-sort="priceFilter" onclick="sortCategory(this.id)"><i class="fas fa-dollar-sign"></i>Price</div>
                  <div class="category sort" id="sort-mint-number" data-sort="mint-number-filter" onclick="sortCategory(this.id)"><i class="fas fa-sort-numeric-down"></i>Mint number</div>
                  <div class="category sort" id="sort-rarity" data-sort="rarityFilter" onclick="sortCategory(this.id)"><i class="tooltip fas fa-gem" data-tooltip-content="#tooltip_rarity"></i>Rarity</div>
                </div>
              </div>
              <div style="display:inline-block;opacity:0;margin-left:1em;" id="sorting-order-container">
                <i id="sorting-order" onclick="sortCategory(this.id)" class="fas fa-2x fa-sort-numeric-down"></i>
              </div>
            </div>

        </div>
    </div>
</div>
<div>
  <div>
    <div id="loader-nftlist" class="block-loader center">
      <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    </div>
    <div id="no-nft" style="display:none;">
        <h3 class="center">RPC Connection Error</h3>
    </div>
    <div id="no-provider" style="display:none;">
        <h3 class="center">NFT API Connection Error</h3>
    </div>
    <div id="container-auctions-list">
      <div class="col-md-12 center" id="auctions-list">
      </div>
    </div>
  </div>
</div>

<div class="tooltip_templates">
    <span id="tooltip_fees">
        Placing an item to sell incurs 0 fees (except the KCAL transaction fee).<br>Cancelling an item sale incurs 0 fees (except the KCAL transaction fee). To cancel, simply click on the item to cancel and confirm.<br>Buying an item costs the price listed plus 2% fees, paid in the item's quote currency (rounded down, and with a minimum of 0.1).<br>Example 1: you're <u>selling</u> one Phantasma car for 10,000 SOUL, you will get 10,000 SOUL.<br>Example 2: you're <u>buying</u> one Phantasma car for 10,000 SOUL, you pay 10,000 SOUL plus a fee of 200 SOUL to get the item.
    </span>
</div>

<div class="tooltip_templates">
    <span id="tooltip_rarity">
      Each item in 22RS has a different quality ranked from most rare to most common:<br><br>Unique > Collector > Custom > Professional > Industrial > Consumer > Common
    </span>
</div>

<div class="tooltip_templates">
    <span id="tooltip_pending">
      This item has just been bought, but the transaction is still being confirmed.<br>It might take up to 2 minutes before it disappears from the Marketplace.<br>Refresh the page will trigger a marketplace refresh.
    </span>
</div>

<div class="tooltip_templates">
    <span id="tooltip_stats">
    </span>
</div>

<div id="alert-area" class="alert-area"></div>

<script>

$(document).ready(function() {

  $('#sendSpinner').hide();

  nftURL = 'http://www.22series.com/api/store/nft';

  fetchSellNFTDropdown = '';
  fetchBuyNFTDropdown = '';

  initialLoad = 0;
  itemBought = 0;

  $("#loader-nftlist").show();
  $("#container-auctions-list").hide();

  // set session storage and filter on load
  localStorage.setItem('marketplace-category-filter', 'filter-all-items');
  filterSelected = localStorage.getItem('marketplace-category-filter');
  //localStorage.setItem('marketplace-category-sort', 'sort-price');
  //selectedMainSort = localStorage.getItem('marketplace-category-sort');

  // pre init filtering
  selectedMainFilter = localStorage.getItem('marketplace-category-filter');

  // preinit sorting order
  sortingOrder = 0;

  // init get auctions
  getAuctions();

  // init tooltipster i
  $('.referral-nft i.tooltip, .tooltip.fas.fa-gem').tooltipster({
    theme: 'tooltipster-light',
    contentCloning: true,
    interactive: true,
    side: 'bottom'
  });

  loadedKCALbalance = 0;
  loadedSOULbalance = 0;
  loadedGOATIbalance = 0;

  {{#each holdings}}
    if ('{{Symbol}}' == 'KCAL') {
      loadedKCALbalance = '{{Amount}}';
      document.getElementById("current-balance-kcal").innerHTML = '<img src="img/kcal_logo.png" alt="KCAL" title="Available Balance" style="margin-right:1em;width:2.5em;">' + numberWithCommas(loadedKCALbalance) + ' KCAL';
    }
    if ('{{Symbol}}' == 'SOUL') {
      loadedSOULbalance = '{{Amount}}';
      document.getElementById("current-balance-soul").innerHTML = '<img src="img/soul_logo.png" alt="SOUL" title="Available Balance" style="margin-right:1em;width:2.5em;">' + numberWithCommas(loadedSOULbalance) + ' SOUL';
    }
    if ('{{Symbol}}' == 'GOATI') {
      loadedGOATIbalance = '{{Amount}}';
      document.getElementById("current-balance-goati").innerHTML = '<img src="img/goati_logo.png" alt="GOATI" title="Available Balance" style="margin-right:1em;width:2.5em;">' + numberWithCommas(loadedGOATIbalance) + ' GOATI';
    }
  {{/each}}

  if (loadedKCALbalance == 0) {
      document.getElementById("current-balance-kcal").innerHTML = '<img src="img/kcal_logo.png" alt="KCAL" title="Available Balance" style="margin-right:1em;width:2.5em;">N/A';
  }
  if (loadedSOULbalance == 0) {
      document.getElementById("current-balance-soul").innerHTML = '<img src="img/soul_logo.png" alt="SOUL" title="Available Balance" style="margin-right:1em;width:2.5em;">N/A';
  }
  if (loadedGOATIbalance == 0) {
      document.getElementById("current-balance-goati").innerHTML = '<img src="img/goati_logo.png" alt="GOATI" title="Available Balance" style="margin-right:1em;width:2.5em;">N/A';
  }

  // preload nft list for selling dropdown bootbox
  sellCustomNFT = []
  arrayNFT = '';
  arrayNFTFormatted = '';
  arrayNFTlength = 0;
  {{#each chainTokens}}
      {{#each Ids}}
      arrayNFTlength++
      {{/each}}
  {{/each}}
  for (i = 0; i < (arrayNFTlength/100); i++) {
    idList = 0;
    window['arrayNFT' + i] = '';
    {{#each chainTokens}}
        {{#each Ids}}
        idList++
        if (idList/100 >= i && idList/100 < (i+1)) {
            window['arrayNFT' + i] += '{{this}}' + ',';
        }
        {{/each}}
    {{/each}}
    window['arrayNFTFormatted' + i] = (window['arrayNFT' + i]).substring(0, (window['arrayNFT' + i]).length - 1)
  }

  if (arrayNFTlength > 0) {

    var arrayNFTFormattedResultTotal = [];
    for (i = 0; i < (arrayNFTlength/100); i++) {
        arrayNFTFormattedResultTotal.push(getNFTIds(window['arrayNFTFormatted' + i]));
    }
    Promise.all(arrayNFTFormattedResultTotal)
    .then(data => {

      // reduce
      dataNFT = data.reduce(function(result, current) {
        return Object.assign(result, current);
      }, {});

      // temp map to array & add id to array
      dataNFT = $.map(dataNFT, function(value, index) { value.id = index; return value; });

      // double sort item & mint
      dataNFT.sort(function (a, b) {

        if (a.item > b.item) return 1;
        if (a.item < b.item) return -1;

        if (a.mint > b.mint) return 1;
        if (a.mint < b.mint) return -1;

      });

      // pre sort by item high first
      let byThis = 'item';
      let compare = (k, kk) => dataNFT[kk][byThis] - dataNFT[k][byThis];
      preSorteddataNFT = Object.keys(dataNFT).sort(compare);

      for (i = 0; i < preSorteddataNFT.length; i++) {

        rarity = '';
        mint = '';
        mintdate = '';
        id = '';
        type = '';
        item = '';
        img = '';
        mintDateFormatted = '';
        name = 'goati server error';

        if (dataNFT[preSorteddataNFT[i]].img) {
          img = dataNFT[preSorteddataNFT[i]].img
        } else {
          img = '/img/nft_notfound.png';
        }
        if (dataNFT[preSorteddataNFT[i]].timestamp) {
          mint_date = dataNFT[preSorteddataNFT[i]].timestamp
          var date = new Date(mint_date * 1000);
          var year = date.getFullYear();
          var month = ("0" + (date.getMonth() + 1)).slice(-2)
          var day = ("0" + (date.getDate() + 1)).slice(-2)
          mintDateFormatted = year + "-" + month + "-" + day;
        }
        sellCustomNFT.push({
            id: dataNFT[preSorteddataNFT[i]].id,
            item: dataNFT[preSorteddataNFT[i]].item,
            mint: dataNFT[preSorteddataNFT[i]].mint,
            rarity: dataNFT[preSorteddataNFT[i]].item_info.rarity,
            mint_date: mintDateFormatted,
            image: img,
            type: dataNFT[preSorteddataNFT[i]].item_info.display_type_english,
            name: dataNFT[preSorteddataNFT[i]].item_info.name_english
        });

      };

    })

    async function getNFTIds(arrayids) {

      let myPromise = new Promise((resolve, reject) => {

      $.ajax({
          xhrFields: {
              withCredentials: !1
          },
          cache: !1,
          crossDomain: !0,
          type: 'POST',
          dataType: 'json',
          data: JSON.stringify({ids: arrayids}),
          url: nftURL,
          success: function(returnedDataTX) {
            var dataNFT = returnedDataTX;
            resolve(dataNFT);
          }
        }).fail(function() {
          console.log('goati api error')
          $("#loader-nftlist").hide();
          $("#no-provider").show();
        })

      });

      let dataNFTdetail = await myPromise;
      return dataNFTdetail;

    }

  } else {
    //$("#sell-nft").fadeTo("slow", 1);
    //$("#sell-nft-tooltip").fadeTo("slow", 1);
  }

});

// On click filtering
function filterCategory(category) {

  $("#loader-nftlist").show();
  $("#container-auctions-list").hide();

  var cat1 = document.getElementById("filter-all-items");
  var cat2 = document.getElementById("filter-my-items");
  var cat3 = document.getElementById("filter-game-access");
  var cat4 = document.getElementById("filter-vehicle-parts");
  var cat5 = document.getElementById("filter-vehicles");
  if (category == 'filter-all-items') {
    cat1.classList.add("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.remove("category-current");
    cat4.classList.remove("category-current");
    cat5.classList.remove("category-current");
    localStorage.setItem('marketplace-category-filter', 'filter-all-items');
  } else if (category == 'filter-my-items') {
    cat1.classList.remove("category-current");
    cat2.classList.add("category-current");
    cat3.classList.remove("category-current");
    cat4.classList.remove("category-current");
    cat5.classList.remove("category-current");
    localStorage.setItem('marketplace-category-filter', 'filter-my-items');
  } else if (category == 'filter-game-access') {
    cat1.classList.remove("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.add("category-current");
    cat4.classList.remove("category-current");
    cat5.classList.remove("category-current");
    localStorage.setItem('marketplace-category-filter', 'License');
  } else if (category == 'filter-vehicle-parts') {
    cat1.classList.remove("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.remove("category-current");
    cat4.classList.add("category-current");
    cat5.classList.remove("category-current");
    localStorage.setItem('marketplace-category-filter', 'Part');
  } else if (category == 'filter-vehicles') {
    cat1.classList.remove("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.remove("category-current");
    cat4.classList.remove("category-current");
    cat5.classList.add("category-current");
    localStorage.setItem('marketplace-category-filter', 'Vehicle');
  }
  selectedMainFilter = localStorage.getItem('marketplace-category-filter');
  // launch refresh auctions once filter has been selected
  //refreshAuctions();
  setTimeout(function(){ refreshAuctions(); }, 100);

}

// On click sorting
function sortCategory(category) {

  $("#loader-nftlist").show();
  $("#container-auctions-list").hide();

  $("#sorting-order-container").fadeTo("fast", 1);
  var cat1 = document.getElementById("sort-price");
  var cat2 = document.getElementById("sort-mint-number");
  var cat3 = document.getElementById("sort-rarity");
  if (category == 'sort-price') {
    cat1.classList.add("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.remove("category-current");
    localStorage.setItem('marketplace-category-sort', 'sort-price');
  } else if (category == 'sort-mint-number') {
    cat1.classList.remove("category-current");
    cat2.classList.add("category-current");
    cat3.classList.remove("category-current");
    localStorage.setItem('marketplace-category-sort', 'sort-mint-number');
  } else if (category == 'sort-rarity') {
    cat1.classList.remove("category-current");
    cat2.classList.remove("category-current");
    cat3.classList.add("category-current");
    localStorage.setItem('marketplace-category-sort', 'sort-rarity');
  } else if (category == 'sorting-order') {
    if (sortingOrder) {
      sortingIcon = 'down';
    } else {
      sortingIcon = 'up';
    }
    sortingOrder = !sortingOrder;
    document.getElementById("sorting-order-container").innerHTML = '<i id="sorting-order" onclick="sortCategory(this.id)" class="fas fa-2x fa-sort-numeric-' + sortingIcon +'"></i>'
  }
  selectedMainSort = category;
  // launch refresh auctions once sorting has been selected
  //refreshAuctions();
  setTimeout(function(){ refreshAuctions(); }, 100);

}

function getStats() {

  $.get('https://neoeconomy.io/json/marketplacetransactions.json',

    function (data) {

      //console.log(data)

      var now = new Date();

      totalUniqueUsers = [...new Set(data.map(item => item.address))].length;
      totalUsers = data.length;

      totalItems = mergedAuctionsFinal.length
      totalItemsOnSale = mergedAuctionsFinalNotExpired.length
      totalItemsExpired = (mergedAuctionsFinal.length) - (mergedAuctionsFinalNotExpired.length)

      currentDay = (now.getTime())/1000;
      startingDay = data[0].time;
      daysElapsed = (currentDay - startingDay) / 60 / 60 / 24;
      txPerDay = (totalUsers/daysElapsed).toFixed(2);

      totalUsersLastDay = 0
      totalUsersBeforeLastDay = 0
      tempUsersArray = []
      tempUsersBeforeArray = []
      for (var i = 0; i < totalUsers; i++) {
        if (data[i].time > (currentDay - 86400)) {
          totalUsersLastDay++
          tempUsersArray.push({
              time: data[i].time,
              hash: data[i].hash,
              address: data[i].address
          });
        }
        if ((data[i].time > (currentDay - (86400*2))) && (data[i].time < (currentDay - (86400)))) {
          totalUsersBeforeLastDay++
          tempUsersBeforeArray.push({
              time: data[i].time,
              hash: data[i].hash,
              address: data[i].address
          });
        }
      }
      totalUniqueUsersLastDay = [...new Set(tempUsersArray.map(item => item.address))].length;
      totalUniqueUsersBeforeLastDay = [...new Set(tempUsersBeforeArray.map(item => item.address))].length;

      if ((((totalUsersLastDay/totalUsersBeforeLastDay) * 100).toFixed(2) - 100) > 0) {
        totalUsersLastDayChange = '+' + (((totalUsersLastDay/totalUsersBeforeLastDay) * 100).toFixed(2) - 100).toFixed(2) + '%';
      } else {
        if (totalUsersBeforeLastDay > 0) {
          totalUsersLastDayChange = (((totalUsersLastDay/totalUsersBeforeLastDay) * 100).toFixed(2) - 100).toFixed(2) + '%';
        } else {
          totalUsersLastDayChange = '';
        }
      }

      if ((((totalUniqueUsersLastDay/totalUniqueUsersBeforeLastDay) * 100).toFixed(2) - 100) > 0) {
        totalUniqueUsersLastDayChange = '+' + (((totalUniqueUsersLastDay/totalUniqueUsersBeforeLastDay) * 100).toFixed(2) - 100).toFixed(2) + '%';
      } else {
        if (totalUniqueUsersBeforeLastDay > 0) {
          totalUniqueUsersLastDayChange = (((totalUniqueUsersLastDay/totalUniqueUsersBeforeLastDay) * 100).toFixed(2) - 100).toFixed(2) + '%';
        } else {
          totalUniqueUsersLastDayChange = '';
        }
      }

      if ((((totalUsersLastDay/totalUsersBeforeLastDay) * 100).toFixed(2) - 100) > 0) {
        totalUsersLastDayChangeClass = '#3e8700'
      } else if ((((totalUsersLastDay/totalUsersBeforeLastDay) * 100).toFixed(2) - 100) == 0.00) {
        totalUsersLastDayChangeClass = 'blue'
      } else {
        totalUsersLastDayChangeClass = 'red'
      }

      if ((((totalUniqueUsersLastDay/totalUniqueUsersBeforeLastDay) * 100).toFixed(2) - 100) > 0) {
        totalUniqueUsersLastDayChangeClass = '#3e8700'
      } else if ((((totalUniqueUsersLastDay/totalUniqueUsersBeforeLastDay) * 100).toFixed(2) - 100) == 0.00) {
        totalUniqueUsersLastDayChangeClass = 'blue'
      } else {
        totalUniqueUsersLastDayChangeClass = 'red'
      }

      dataTooltipStats = ''
        + '<div class="center" style="font-size:.9;margin-top:1em;">'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">TOTAL ITEMS</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalItems) + '<span></span></span></div>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">ITEMS AVAILABLE</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalItemsOnSale) + '<span></span></span></div>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">ITEMS EXPIRED</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalItemsExpired) + '<span></span></span></div><br>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">TOTAL TRANSACTIONS</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalUsers) + '<span></span></span></div>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">TOTAL USERS</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalUniqueUsers) + '<span></span></span></div>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">AVERAGE TX PER DAY</span><br><span style="font-size: 1.5em;">' + numberWithCommas(txPerDay) + '<span></span></span></div><br>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">24H TRANSACTIONS</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalUsersLastDay) + ' <span style="font-size:.8em;color:' + totalUsersLastDayChangeClass + '">' + totalUsersLastDayChange + '</span><span></span></span></div>'
        + '<div style="display:inline-block;margin-bottom:1.5em;margin-left:1em;margin-right:1em;line-height: 1.2em;"><span class="span-stats">24H USERS</span><br><span style="font-size: 1.5em;">' + numberWithCommas(totalUniqueUsersLastDay) + ' <span style="font-size:.8em;color:' + totalUniqueUsersLastDayChangeClass + '">' + totalUniqueUsersLastDayChange + '</span><span></span></span></div><br>'
        + '<div style="margin-bottom:1em;display:inline-block;"><div id="container-tx-historical" style="height: 320px;width: 400px;z-index:999; margin: 0 auto"></div></div>'
        + '</div>';

      document.getElementById("tooltip_stats").innerHTML = dataTooltipStats;

      $('#tooltip-stats-container').show('fast');

      $.getJSON('https://neoeconomy.io/json/marketplacetransactionsdaily.json', function(data) {

          var ohlc = [],
              ohlc2 = [],
              dataLength = data.length,
              i = 0,
              amountTotal = 0;
          for (i; i < dataLength; i += 1) {
              ohlc.push([
                  data[i].time * 1000,
                  parseFloat(data[i].amount),
              ]);
              amountTotal += parseFloat(data[i].amount)
              ohlc2.push([
                  data[i].time * 1000,
                  amountTotal
              ]);
          }

          Highcharts.setOptions({
              lang: {
                  rangeSelectorZoom: ''
              }
          });

          Highcharts.stockChart('container-tx-historical', {
              title: {
                  text: 'Historical Marketplace Transactions',
                  style: {
                      fontFamily: 'Rubik',
                      color: "#333"
                  }
              },
              chart: {
                  backgroundColor: 'transparent',
                  style: {
                      fontFamily: 'Rubik',
                      color: "#333"
                  }
              },
              xAxis: {
                type: 'datetime',
                labels: {
                  formatter: function() {
                    return Highcharts.dateFormat('%d %b %Y', this.value);
                  },
                  style: {
                      fontFamily: 'Rubik',
                      color: "#333"
                  }
                }
              },
              yAxis: [{
                  gridLineWidth: 0,
                  minorGridLineWidth: 0,
                  labels: {
                      formatter: function() {
                          return this.axis.defaultLabelFormatter.call(this);
                      },
                      style: {
                          fontFamily: 'Rubik',
                          color: "#333"
                      }
                  },
                  min: 0,
                  opposite: false
              },{
                  labels: {
                      formatter: function() {
                          return this.axis.defaultLabelFormatter.call(this);
                      },
                      style: {
                          fontFamily: 'Rubik',
                          color: "#333",
                      }
                  },
                  opposite: true,
                  min: 0,
                  gridLineWidth: 0,
                  minorGridLineWidth: 0
              }],
              navigator: {
                  enabled: false
              },
              scrollbar: {
                  enabled: false
              },
              rangeSelector: {
                  selected: 0,
                  enabled: false
              },
              legend: {
                  enabled: true,
                  itemStyle: {
                    fontFamily: 'Rubik',
                    color: "#333",
                    fontWeight: "Light"
                  }
              },
              credits: {
                  enabled: false
              },
              exporting: {
                  enabled: false
              },
              plotOptions: {
                  area: {
                      marker: {
                          radius: 4
                      },
                      lineWidth: 3,
                      states: {
                          hover: {
                              lineWidth: 1
                          }
                      },
                      threshold: null
                  }
              },
              tooltip: {
                  shared: true,
                  split: false,
                  formatter: function() {
                      var s = Highcharts.dateFormat('%A, %b %d, %Y - %H:%M', new Date(this.x));
                      $.each(this.points, function(i, point) {
                          s += '<br/><span style="color:' + point.color + '">\u25CF</span> ' + point.series.name + ' <b>' + Highcharts.numberFormat(point.y, 0, '.', ',') + '</b>';
                      });
                      return s;
                  }
              },
              series: [{
                  type: 'area',
                  name: 'Daily Transactions',
                  data: ohlc,
                  color: '#17B0E7',
                  fillColor: {
                      linearGradient: {
                          x1: 1,
                          y1: 1,
                          x2: 1,
                          y2: 1
                      },
                      stops: [
                          [0, '#333'],
                          [1, '#333']
                      ]
                  }
              },{
                  type: 'area',
                  name: 'Total Transactions',
                  yAxis: 1,
                  data: ohlc2,
                  color: '#FFBF32',
                  fillOpacity: 0
              }]
          });

          // init tooltipster i after highcharts loaded
          $('i#tooltip-stats-container').tooltipster({
            theme: 'tooltipster-light',
            contentCloning: true,
            interactive: true,
            side: 'bottom'
          });

      }).fail(function() {
        $('i#tooltip-stats-container').hide();
        console.log("error api call");
      });

    }
  ).fail(function() {
    $('i#tooltip-stats-container').hide();
    console.log("error api call");
  });

}

function getAuctions() {

      $.when(

        $.get('https://neoeconomy.io/json/auctionsmarketplace.json',

          function (data) {
            //console.log(data)
            dataAPIMain = data
          }

        ),
        $.get('https://neoeconomy.io/json/auctionsmarketplace-goati.json',

          function (data) {
            //console.log(data)
            dataAPIGoati = data
          }

        )

      ).then(function() {

        mergedAuctionsFinal = Array.prototype.concat.apply([], dataAPIMain.map(function(res) {
            return res
        }));

        // filter by start date
        mergedAuctionsFinal.sort((a,b) => (a.startDate < b.startDate) ? 1 : ((b.startDate < a.startDate) ? -1 : 0));

        lenAuctions = (mergedAuctionsFinal).length;

        mergedAuctionsFinalNotExpired = mergedAuctionsFinal.filter(function (el) {
          return el.endDate > (((new Date()).getTime())/1000);
        });

        // filter by start date
        mergedAuctionsFinalNotExpired.sort((a,b) => (a.startDate < b.startDate) ? 1 : ((b.startDate < a.startDate) ? -1 : 0));

        auctionsDetailsAPINFT = mergedAuctionsFinal;

        // start marketplace stats
        getStats();

        // init empty pendingItems
        pendingItems = [];

        // start refresh auctions
        refreshAuctions();

        // preload nft list for buying dropdown bootbox
        buyCustomNFT = dataAPIGoati

        // double sort item & mint
        buyCustomNFT.sort(function (a, b) {

          if (parseFloat(a.item) < parseFloat(b.item)) return 1;
          if (parseFloat(a.item) > parseFloat(b.item)) return -1;

          if (parseFloat(a.mint) > parseFloat(b.mint)) return 1;
          if (parseFloat(a.mint) < parseFloat(b.mint)) return -1;

        });

        countExpired = 0;
        fetchBuyNFTDropdown = '<select multiple style="margin: .5em auto;" id="select-nft-buy">';
        //fetchBuyNFTDropdown += '<option value="">Select NFT to sell</option>'

        /*
        // check difference between APIs
        console.log(buyCustomNFT)
        console.log(mergedAuctionsFinal)
        var res = buyCustomNFT.filter(item1 =>
        !mergedAuctionsFinal.some(item2 => (item2.tokenId === item1.id)))
        console.log(res);
        */

        for (i = 0; i < buyCustomNFT.length; i ++) {

          buyType = buyCustomNFT[i].type
          buyName = (buyCustomNFT[i].name).substr(2)
          buyMint = buyCustomNFT[i].mint
          buyItem = buyCustomNFT[i].item
          buyMinDate = buyCustomNFT[i].mint_date
          var date = new Date(buyMinDate * 1000);
          var year = date.getFullYear();
          var month = ("0" + (date.getMonth() + 1)).slice(-2)
          var day = ("0" + (date.getDate())).slice(-2)
          buyMintDateFormatted = year + "-" + month + "-" + day;
          buyRarity = formatRarity(buyCustomNFT[i].rarity)
          buyId = buyCustomNFT[i].id
          buyPriceRaw = mergedAuctionsFinal.filter(function (el) {
            return el.tokenId == dataAPIGoati[i].id;
          });
          buyCurrency = buyPriceRaw[0].quoteSymbol
          buyPrice = (buyPriceRaw[0].price)/(Math.pow(10,formatDecimals(buyCurrency)));
          buyPriceCustomReal = (buyPriceRaw[0].price)/(Math.pow(10,formatDecimals(buyCurrency)));
          buyCreator = buyPriceRaw[0].creatorAddress

          if ((((buyPriceRaw[0].endDate)*1000) - (new Date()).getTime() < 0) && buyCreator != '{{address}}') {
            countExpired++
            continue;
          }

          if (buyCreator == '{{address}}') {
            classCreator = "classCreator";
            buyPriceCustom = 0;
            buyMyitems = 'filter-myItems';
          } else {
            classCreator = '';
            buyPriceCustom = (buyPriceRaw[0].price)/(Math.pow(10,formatDecimals(buyCurrency)));
            buyMyitems = '';
          }

          lenAuctionsBuy = buyCustomNFT.length - countExpired;

          if (((buyPriceRaw[0].endDate)*1000) - (new Date()).getTime() < 0) {
            expiredItem = ' • Expired'
          } else {
            expiredItem = ''
          }

          fetchBuyNFTDropdown += '<option value="' + buyCustomNFT[i].id + '" class=" ' + classCreator + ' filter-type filter-type-' + buyType + ' filter-rarity filter-rarity-' + buyRarity + ' filter-currency filter-currency-' + buyCurrency +  ' ' + buyMyitems + '" priceReal="' + buyPriceCustomReal + '" creatorAddress="' + buyCreator + '" item="' + buyItem + '" mint="' + buyMint + '" rarity="' + buyRarity + '">' + buyName + ' • Mint #' + buyMint + ' • Minted on ' + buyMintDateFormatted + ' • ' + buyRarity + ' • ' + numberWithCommas(buyPrice) + ' ' + buyCurrency + expiredItem + '</option>'
        }
        fetchBuyNFTDropdown += '</select>'

  })
}

// function refresh auctions
function refreshAuctions() {

  fetchAuctions = '';
  tooltipAuction = '';

  // start building the search input
  fetchAuctions += '<div class="col-md-12 center" id="head-input-search">'
        +    '<div style="margin-top: .5em;margin-bottom:-.7em;">'
        +      '<p>Search for an item</p>'
        +    '</div>'
        +    '<form>'
        +      '<input id="input-search" type="search"placeholder="ITEM" class="search"><div id="count-search" style="display: inline-block;margin-left: 1em;"></div>'
        +    '</form>'
        + '</div>'

  fetchAuctions += '<ul class="paginationTop pagination"></ul>'
  fetchAuctions += '<ul class="list">'

    // start full details
    for (i = 0, len = lenAuctions; i < lenAuctions; i++) {

      singleDetailsAPINFT = dataAPIGoati.filter(function (el) {
        return el.id == auctionsDetailsAPINFT[i].tokenId;
      });

      // hide ended auctions except for self auction
      if ((((auctionsDetailsAPINFT[i].endDate)*1000) - (new Date()).getTime() < 0) && auctionsDetailsAPINFT[i].creatorAddress != '{{address}}') {
        continue;
      }

      // catch all bogus auction count
      if (!singleDetailsAPINFT[0]) {
        continue;
      }

      // only show items based on filter
      if (selectedMainFilter == singleDetailsAPINFT[0].type || (selectedMainFilter == 'Part' && singleDetailsAPINFT[0].type == 'Pack') || selectedMainFilter == 'filter-all-items' || selectedMainFilter == 'filter-my-items') {
        // if filter is my items OR everything else if not my items
        if (auctionsDetailsAPINFT[i].creatorAddress == '{{address}}' || selectedMainFilter !== 'filter-my-items') {

          creatorAddress = auctionsDetailsAPINFT[i].creatorAddress;
          if (creatorAddress.length > 20) {
            lastFiveAddr = creatorAddress.substr(creatorAddress.length - 5);
            firstFiveAddr = creatorAddress.substr(0, 5);
            addressFormated = firstFiveAddr + '...' + lastFiveAddr;
          } else {
            addressFormated = creatorAddress
          }
          //startDate = auctionsDetailsAPINFT[i].startDate;
          endDate = auctionsDetailsAPINFT[i].endDate;
          quoteSymbol = auctionsDetailsAPINFT[i].quoteSymbol;
          tokenID = auctionsDetailsAPINFT[i].tokenId;
          name = (singleDetailsAPINFT[0].name).replace(' • ', '');
          if (name.length > 29) {
            nameRaw = name.substr(0, 29) + '..';
          } else {
            nameRaw = name;
          }
          item = (singleDetailsAPINFT[0].item);
          priceRaw = (auctionsDetailsAPINFT[i].price)/(Math.pow(10,formatDecimals(quoteSymbol)));
          price = numberWithCommas(priceRaw);

          pendingItem = pendingItems.filter(function (el) {
            return el.id == tokenID;
          });

          pendingClass = ''

          if (pendingItem[0]) {
            if (tokenID == pendingItem[0].id) {
              priceFormatted = 'PENDING'
              cancelClass = 'cancel'
              pendingClass = '<button class="tooltip nft-order info pending" data-tooltip-content="#tooltip_pending"><i class="fas fa-info" style="width:1em;"></i></button>'
            } else {
              if (auctionsDetailsAPINFT[i].creatorAddress == '{{address}}') {
                priceFormatted = price + ' ' + quoteSymbol + ' - CANCEL'
                cancelClass = 'cancel'
              } else {
                priceFormatted = 'BUY FOR ' + price + ' ' + quoteSymbol
                cancelClass = ''
              }
            }
          } else {
            if (auctionsDetailsAPINFT[i].creatorAddress == '{{address}}') {
              priceFormatted = price + ' ' + quoteSymbol + ' - CANCEL'
              cancelClass = 'cancel'
            } else {
              priceFormatted = 'BUY FOR ' + price + ' ' + quoteSymbol
              cancelClass = ''
            }
          }

          rarity = formatRarity(singleDetailsAPINFT[0].rarity);
          season = formatSeason(singleDetailsAPINFT[0].season);
          mintNumber = singleDetailsAPINFT[0].mint;
          mintDate = singleDetailsAPINFT[0].mint_date;
          mintLimit = singleDetailsAPINFT[0].mint_limit;
          if (mintLimit == 0) {
            mintLimit = 'Unlimited'
          }
          image = singleDetailsAPINFT[0].image;
          url = singleDetailsAPINFT[0].image;
          type = singleDetailsAPINFT[0].type;
          if ((singleDetailsAPINFT[0].description).length > 30) {
            description = '<br>' + singleDetailsAPINFT[0].description;
          } else {
            description = singleDetailsAPINFT[0].description;
          }
          var date = new Date(mintDate * 1000);
          var year = date.getFullYear();
          var month = ("0" + (date.getMonth() + 1)).slice(-2)
          var day = ("0" + (date.getDate())).slice(-2)
          mintDateFormatted = year + "-" + month + "-" + day;
          var timeleft = ((endDate)*1000) - (new Date()).getTime();
          if (((((timeleft / 1000) / 60) / 60) < 1) && ((((timeleft / 1000) / 60) / 60) > 0)) {
            var hoursleft = numberWithCommas(Math.ceil((((timeleft / 1000) / 60)))) + ' MINUTES LEFT';
          } else {
            if ((((timeleft / 1000) / 60) / 60) > 96) {
              var hoursleft = numberWithCommas(Math.ceil((((timeleft / 1000) / 60) / 60 / 24))) + ' DAYS LEFT';
            } else if (timeleft > 0){
              var hoursleft = numberWithCommas(Math.ceil((((timeleft / 1000) / 60) / 60))) + ' HOURS LEFT';
            } else {
              var hoursleft = 'ENDED';
            }
          }
          if (((((timeleft / 1000) / 60) / 60) < 1) && ((((timeleft / 1000) / 60) / 60) > 0)) {
            var hoursleftRaw = numberWithCommas(Math.ceil((((timeleft / 1000) / 60)))) + ' minutes';
          } else {
            if ((((timeleft / 1000) / 60) / 60) > 96) {
              var hoursleftRaw = numberWithCommas(Math.ceil((((timeleft / 1000) / 60) / 60 / 24))) + ' days';
            } else if (timeleft > 0){
              var hoursleftRaw =  numberWithCommas(Math.ceil((((timeleft / 1000) / 60) / 60))) + ' hours';
            } else {
              var hoursleftRaw = 'Ended';
            }
          }

          // tooltip construct
          tooltipAuction = ''
                      + '<div class="tooltip-container"><br>'
                      + '• <strong>Item: </strong>' + name + '<br><br>'
                      + '• <strong>Price: </strong>' + price + ' ' + quoteSymbol + '<br><br>'
                      + '• <strong>Current owner: </strong><a class="raw-link" href="https://www.22series.com/inventory?#' + creatorAddress + '" target="_blank">' + addressFormated + '</a><br><br>'
                      + '• <strong>Type: </strong>' + type + '<br><br>'
                      + '• <strong>Description: </strong>' + description + '<br><br>'
                      + '• <strong>Sale ends in: </strong>' + hoursleftRaw + '<br><br>'
                      + '• <strong>Mint number: </strong>#' + mintNumber + '<br><br>'
                      + '• <strong>Mint date: </strong>' + mintDateFormatted + '<br><br>'
                      + '• <strong>Rarity: </strong>' + rarity + '<br><br>'
                      + '• <strong>Season: </strong>' + season + '<br><br>'
                      + '• <strong>Mint limit: </strong>' + mintLimit + '<br><br>'
                      + '• <strong>Details: </strong><a class="raw-link" href="https://www.22series.com/part_info?id=' + tokenID + '" target="_blank">See the complete details</a><br><br>'
                      + '</div>';

          // auction construct
          fetchAuctions += '<li><div class="nft-class">'
            + '<div class="nft-image" style="width:24em;" onclick="confirmBuyNFT(\'' + quoteSymbol + '\',\'' + tokenID + '\',\'' + priceRaw + '\',\'' + name + '\',\'' + mintNumber + '\',\'' + mintDateFormatted + '\',\'' + creatorAddress + '\')">'
            +   '<button class="nft-order circulating">' + hoursleft + '</button>'
            +   pendingClass
            +   '<button class="nft-order supply priceFilter ' + cancelClass + '">' + priceFormatted + '</button>'
            +   '<img src="' + image + '?width=256" alt="" style="height:12em;padding-top:3em;">'
            +   '<div class="nft-desc item-filter">'
            +     '<h3 style="display:inline-block;">' + nameRaw + '</h3><br>'
            +     '<div style="text-align:center;">'
            +       '<button class="nft-order price mint-number-filter" >#' + mintNumber + '</button>'
            +       '<button class="nft-order price">' + mintDateFormatted + '</button>'
            +       '<button class="nft-order price rarity-' + rarity.toLowerCase() + ' rarityFilter">' + rarity.toUpperCase() + '</button>'
            +       '<button class="tooltip nft-order info" data-tooltip-content="#tooltip_' + [i] + '">'
            +         '<i class="fas fa-info" style="width:1em;"></i>'
            +         '<div class="tooltip_templates"><span id="tooltip_' + i + '">' + tooltipAuction + '</span></div>'
            +       '</button>'
            +     '</div>'
            +   '</div>'
            + '</div>'
            +'</div></li>'

        }

      }

    }

    // complete ul list for list js
    fetchAuctions += '</ul>'
    fetchAuctions += '<ul class="paginationBottom pagination"></ul>'

    // fill auctions
    document.getElementById("auctions-list").innerHTML = fetchAuctions;

    // init sorting custom for initial load
    if (initialLoad == 0) {
      //document.getElementById("sort-price").classList.add("category-current");
    }

    // fill total items container on initial load
    if (initialLoad == 0) {
        document.getElementById("prizepool").innerHTML = numberWithCommas(mergedAuctionsFinalNotExpired.length) + ' NFTs';
    }

    // start list js based on item-filter values
    var options = {
      valueNames: [ 'item-filter', 'priceFilter', 'mint-number-filter', 'rarityFilter' ],
      page: 50,
      pagination: [{
        name: "paginationTop",
        paginationClass: "paginationTop",
        innerWindow: 2,
        outerWindow: 1
      }, {
        innerWindow: 2,
        name: "paginationBottom",
        paginationClass: "paginationBottom",
        outerWindow: 1
      }]
    };
    var itemsList = new List('auctions-list', options);

    itemsList.on('updated', function () {

      if ($('button.tooltip').hasClass("tooltipstered")) {
        $('button.tooltip.nft-order.info.tooltipstered').tooltipster('destroy');
      }

      $('button.tooltip').tooltipster({
        theme: 'tooltipster-light',
        contentCloning: true,
        interactive: true,
        side: 'top'
      });

    });

    // custom sort for rarity except initial load
    if (initialLoad == 1) {
      if (localStorage.getItem('marketplace-category-sort') == 'sort-rarity') {

        item_order = ["COMMON","CONSUMER","INDUSTRIAL","PROFESSIONAL","CUSTOM","COLLECTOR","UNIQUE"];

        if (sortingOrder) {
          order = "desc"
        } else {
          order = "asc"
        }

        itemsList.sort(formatSorting(localStorage.getItem('marketplace-category-sort')), {
            order: order,
            sortFunction: function (a, b) {
              a = item_order.indexOf(a._values.rarityFilter);
              b = item_order.indexOf(b._values.rarityFilter);
              return a - b;
           }
        })

      } else if (localStorage.getItem('marketplace-category-sort') == 'sort-price') {

        if (sortingOrder) {
          order = "desc"
        } else {
          order = "asc"
        }

        itemsList.sort(formatSorting(localStorage.getItem('marketplace-category-sort')), {
            order: order,
            sortFunction: function (a, b) {
                a = parseFloat(a._values.priceFilter.toString().replace(' - CANCEL','').replace(',','').replace('BUY FOR','').replace('SOUL','').replace('KCAL','').replace('GOATI',''));
                b = parseFloat(b._values.priceFilter.toString().replace(' - CANCEL','').replace(',','').replace('BUY FOR','').replace('SOUL','').replace('KCAL','').replace('GOATI',''));
                return a > b ? 1 :
                       a < b ? -1 : 0;
            }
        })

      } else {
        if (sortingOrder) {
          order = "desc"
        } else {
          order = "asc"
        }

        itemsList.sort(formatSorting(localStorage.getItem('marketplace-category-sort')), {
            order: order
        })
      }
    }

    // hide pagination if single page
    if ((itemsList.matchingItems).length <= itemsList.page) {
      $('.paginationBottom').css('display', 'none');
    } else {
      $('.paginationBottom').css('display', 'block');
    }

    // init filtering custom for initial load
    if (initialLoad == 0 && itemBought == 0) {
      var cat1 = document.getElementById("filter-all-items");
      cat1.classList.add("category-current");
      localStorage.setItem('marketplace-category-filter', 'filter-all-items');
      selectedMainFilter = localStorage.getItem('marketplace-category-filter');
      initialLoad = 1;
    }

    // show auctions
    $("#loader-nftlist").hide();
    $("#container-auctions-list").show();

    // init sell/buy button
    $("#buy-nft").fadeTo("slow", 1);
    $("#sell-nft").fadeTo("slow", 1);
    $("#sell-nft-tooltip").fadeTo("slow", 1);

    // init filters & prizepool
    $(".wrapper-filters").fadeTo("slow", 1);
    $(".wrapper-sorters").fadeTo("slow", 1);
    $(".container-prize").fadeTo("slow", 1);

    $("#input-search").on("input", function() {
      setTimeout(function(){
          if ((itemsList.matchingItems).length > 1) {
            fetchValuesCount = (itemsList.matchingItems).length + ' items available';
          } else {
            fetchValuesCount = (itemsList.matchingItems).length + ' item available';
          }
          $('#count-search').html(fetchValuesCount);

          // hide pagination if single page
          if ((itemsList.matchingItems).length <= itemsList.page) {
            $('.paginationBottom').css('display', 'none');
          } else {
            $('.paginationBottom').css('display', 'block');
          }
         }, 1000);

    })

    // init items count search
    if ((itemsList.matchingItems).length > 1) {
      fetchValuesCount = (itemsList.matchingItems).length + ' items available';
    } else {
      fetchValuesCount = (itemsList.matchingItems).length + ' item available';
    }
    $('#count-search').html(fetchValuesCount);

    // init tooltipster button
    if ($('button.tooltip').hasClass("tooltipstered")) {
      $('button.tooltip.nft-order.info.tooltipstered').tooltipster('destroy');
    }

    $('button.tooltip').tooltipster({
      theme: 'tooltipster-light',
      contentCloning: true,
      interactive: true,
      side: 'top'
    });

}

// function format season
function formatSeason(season) {

  switch(season)
  {
    case 1: return 'Pre-season';
    default: return 'Unknown';
  }

}

// function format rarity
function formatRarity(rarity) {

  switch(rarity)
  {
    case 1: return 'Consumer';
    case 2: return 'Industrial';
    case 3: return 'Professional';
    case 4: return 'Custom';
    case 5: return 'Collector';
    case 6: return 'Unique';
    default: return 'Common';
  }

}

// function format sorting
function formatSorting(sorting) {

  switch(sorting)
  {
    case 'sort-price': return 'priceFilter';
    case 'sort-mint-number': return 'mint-number-filter';
    case 'sort-rarity': return 'rarityFilter';
    default: return 'priceFilter';
  }

}

// function format token decimals
function formatDecimals(symbol) {

  switch(symbol)
  {
    case 'SOUL': return 8;
    case 'KCAL': return 10;
    case 'GOATI': return 3;
    case 'GAS': return 8;
    case 'NEO': return 0;
    default: return 0;
  }

}

// Confirm buy nft
function confirmBuyNFT(quoteSymbol, idNFT, priceNFT, nameNFT, mintNFT, mindDateNFT, creatorAddress) {

  if (quoteSymbol == 'SOUL') {

    if (creatorAddress !== '{{address}}') {

      if (parseFloat(loadedSOULbalance) < (parseFloat(priceNFT))*1.02) {
            bootbox.alert('Not enough SOUL available. You need ' + numberWithCommas(Math.ceil((parseFloat(priceNFT)*1.02) - parseFloat(loadedSOULbalance))) + ' more SOUL to buy this NFT!');
            return;
      }

    }

  } else if (quoteSymbol == 'KCAL') {

    if (creatorAddress !== '{{address}}') {

      if (parseFloat(loadedKCALbalance) < (parseFloat(priceNFT))*1.02) {
            bootbox.alert('Not enough KCAL available. You need ' + numberWithCommas(Math.ceil((parseFloat(priceNFT)*1.02) - parseFloat(loadedKCALbalance))) + ' more KCAL to buy this NFT!');
            return;
      }

    }

  } else if (quoteSymbol == 'GOATI') {

    if (creatorAddress !== '{{address}}') {

      if (parseFloat(loadedGOATIbalance) < (parseFloat(priceNFT))*1.02) {
            bootbox.alert('Not enough GOATI available. You need ' + numberWithCommas(Math.ceil((parseFloat(priceNFT)*1.02) - parseFloat(loadedGOATIbalance))) + ' more GOATI to buy this NFT!');
            return;
      }

    }

  }

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
        bootbox.alert("Not enough KCAL available. You need at least 0.1 KCAL to perform a transaction!");
        return;
  }

  params = [];
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: ''  }
  params[1] = { name: 'symbol', type: 'String', input: 'TTRS', info: '' },
  params[2] = { name: 'tokenID', type: 'Number', input: idNFT, info: '' }

  $('#sendSpinner').show();

  if (creatorAddress == '{{address}}') {
    descText = 'You are going to cancel the sale of <strong>'
    titleText = 'NFT cancel sale confirmation'
    buttonCancelText = 'Cancel NFT sale'
    actionText = ' and currently in sale for ';
    buyerFee = 0;
    finalFee = 0;
    feeText = ''
  } else {
    descText = 'You are going to buy <strong>'
    titleText = 'NFT buy confirmation'
    buttonCancelText = 'Buy NFT'
    actionText = ' for ';
    buyerFee = 0.02;
    if (roundDown((priceNFT*buyerFee),2) < 0.10) {
      finalFee = 0.1
      feeText = '(and a min fee of: <strong>' + finalFee + ' ' + quoteSymbol + ')</strong>'
    } else {
      finalFee = roundDown((priceNFT*buyerFee),2);
      feeText = '(and a 2% fee: <strong>' + finalFee + ' ' + quoteSymbol + ')</strong>'
    }
  }

  contentBootbox = descText
      + nameNFT + '</strong> • Mint <strong>#' + mintNFT + '</strong> • Minted on <strong>' + mindDateNFT
      + '</strong> ' + actionText + ' <strong>'
      + numberWithCommas(parseFloat(priceNFT))
      + ' ' + quoteSymbol + ' </strong>' + feeText
      + '<br><br><i><span style="font-size:.7em;">The NFT will show up in your portfolio within 10 seconds.</span></i>';
  dialog = bootbox.confirm({
      title: titleText,
      message: contentBootbox,
      buttons: {
          cancel: {
              label: '<i class="fa fa-times"></i> Cancel'
          },
          confirm: {
              label: '<i class="fa fa-check"></i> ' + buttonCancelText
          }
      },
      callback: function(result) {

        if (result) {

          $.post('/marketbuycustom',
             {
                 chain: 'main',
                 contract: 'market',
                 method: 'BuyToken',
                 params: JSON.stringify({
                   params
                 }),
                 feeamount: finalFee,
                 feesymbol: quoteSymbol
             },
             function (returnedData) {
                 if (returnedData !== "") {
                     pendingItems.push ({
                         id: idNFT
                     });
                     $('#sendSpinner').hide();
                     alertbox.show('Transaction successful!');
                     itemBought = 1;
                     refreshAuctions();
                 } else {
                     window.location.replace("/error");
                 }
                 console.log(returnedData);
             }).fail(function() {
             $('#sendSpinner').hide();
             console.log("error marketplace");
             })

        } else {
            $('#sendSpinner').hide();
        }

      }
    })

}

// Initiate sell nft
function initiateSell() {

  if (sellCustomNFT.length == 0 || sellCustomNFT.length == null) {
        bootbox.alert("You don't have any NFT to sell!");
        return;
  }

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
        bootbox.alert("Not enough KCAL available. You need at least 0.1 KCAL to perform a transaction!");
        return;
  }

  fetchSellNFTDropdown = '<div id="loader-nftlist-modal" style="display:none;" class="block-loader center"><div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div></div><select multiple style="margin: .5em auto;" id="select-nft">';
  //fetchSellNFTDropdown += '<option value="">Select NFT to sell</option>'
  for (i = 0; i < sellCustomNFT.length; i ++) {

    sellMint = sellCustomNFT[i].mint
    sellItem = sellCustomNFT[i].item
    sellRarity = formatRarity(sellCustomNFT[i].rarity)

    fetchSellNFTDropdown += '<option value="' + sellCustomNFT[i].id + '" data-image="' + sellCustomNFT[i].image + '" class="filter-type filter-type-' + sellCustomNFT[i].type + ' filter-rarity filter-rarity-' + formatRarity(sellCustomNFT[i].rarity) + '" item="' + sellItem + '" mint="' + sellMint + '" rarity="' + sellRarity + '">' + sellCustomNFT[i].name + ' • Mint #' + sellCustomNFT[i].mint + ' • Minted on ' + sellCustomNFT[i].mint_date + ' • ' + formatRarity(sellCustomNFT[i].rarity) + '</option>'

  }
  fetchSellNFTDropdown += '</select>'

  confirmSellInitial();

  function confirmSellInitial() {

    $('#sendSpinner').show();

    contentBootbox = '1) Select the NFT(s) you would like to sell:<br><i><span style="font-size:.7em;">You can select multiple NFT(s) by pressing shift/control.</span></i><br><br>'
                  + '<div class="filter-results">Type: <select style="margin-left:1em;margin-right:1em;display:inline-block;height: 2.5em;text-transform:uppercase;display:inline-block;" id="sell-type-filter"><option value="any">Any</option><option value="license">Game Access</option><option value="part">Vehicle Parts</option><option value="vehicle">Vehicles</option></select>'
                  + 'Rarity: <select style="margin-left:1em;margin-right:1em;height: 2.5em;text-transform:uppercase;" id="sell-rarity-filter"><option value="any">Any</option><option value="consumer">Consumer</option><option value="industrial">Industrial</option><option value="professional">Professional</option><option value="custom">Custom</option><option value="collector">Collector</option><option value="unique">Unique</option></select>'
                  + 'Sort by: <select style="margin-left:.5em;margin-right:1em;height: 2.5em;text-transform:uppercase;" id="sell-sort"><option value="item">Item</option><option value="mint">Mint #</option><option value="rarity">Rarity</option></select>'
                  + '<span id="sorting-order-container-modal"><i id="sorting-order-modal-down" onclick="sortTypeModal()" class="fas fa-sort-numeric-down"></i></span></div>'
                  + '<div class="filter-results-count">You have <strong><span id="available-nfts">' + sellCustomNFT.length + '</span> NFTs available</strong> matching these filters.</div>'
                  + fetchSellNFTDropdown
                  + '<div class="filter-results-count" id="filter-results-count">You have selected <strong><span id="selected-nfts">0</span> NFTs </strong> to be sold.</div><br>'
                  + '2) Specify amount, currency and duration of your sale:<br><br>'
                  + '<div class="center"><input type="text" class="form-control" name="sell-amount" style="width:60%;display:inline-block" id="sell-amount">'
                  + '<select style="margin-left:2em;display:inline-block;height: 2.5em;text-transform:uppercase;" id="sell-currency"><option value="SOUL">SOUL</option><option value="KCAL">KCAL</option><option value="GOATI">GOATI</option></select>'
                  + '<select style="margin-left:2em;display:inline-block;height: 2.5em;text-transform:uppercase;" id="sell-enddate">'
                  + '<option value="1">1 day</option><option value="2">2 days</option><option value="3">3 days</option><option value="4">4 days</option><option value="5">5 days</option><option value="6">6 days</option><option value="7">7 days</option><option value="8">8 days</option><option value="9">9 days</option><option value="10">10 days</option>'
                  + '<option value="11">11 days</option><option value="12">12 days</option><option value="13">13 days</option><option value="14">14 days</option><option value="15">15 days</option><option value="16">16 days</option><option value="17">17 days</option><option value="18">18 days</option><option value="19">19 days</option><option value="20">20 days</option>'
                  + '<option value="21">21 days</option><option value="22">22 days</option><option value="23">23 days</option><option value="24">24 days</option><option value="25">25 days</option><option value="26">26 days</option><option value="27">27 days</option><option value="28">28 days</option><option value="29">29 days</option><option value="30">30 days</option>'
                  + '</select></div>'

    dialog = bootbox.confirm({
        title: "NFT sell selection",
        message: contentBootbox,
        buttons: {
            cancel: {
                label: '<i class="fa fa-times"></i> Cancel',
                className:'btn btn-default'
            },
            confirm: {
                label: '<i class="fa fa-check"></i> Sell NFT',
                className:'btn btn-primary sell-confirm'
            }
        },
        callback: function(result) {

          //$("#select-id").msDropDown();

          if (result) {

            var e = document.getElementById("sell-currency");
            sellCurrency = e.options[e.selectedIndex].value;
            var f = document.getElementById("select-nft");
            //idNFT = f.options[f.selectedIndex].value;
            bulkdIdNFT = $('#select-nft').val()
            var g = document.getElementById("sell-enddate");
            endDate = g.options[g.selectedIndex].value;
            results = {};
            results.fieldname1 = dialog[0].querySelector("[name=sell-amount]").value;
            sellAmount = results.fieldname1

            nftIdArr = [];
            for (var i = 0; i < bulkdIdNFT.length; i++) {
              nftIdArr.push ({
                  id: bulkdIdNFT[i]
              });
            }

            // second confirm
            if ($("#select-nft :checked").length > 1) {
                confirmSecondQty = $("#select-nft :checked").length + ' NFTs'
                confirmSecondBtn = 'NFTs'
                confirmSecondDesc = 'NFTs'
            } else {
                confirmSecondQty = $("#select-nft :checked").length + ' NFT'
                confirmSecondBtn = 'NFT'
                confirmSecondDesc = 'NFT'
            }
            if ($("#sell-amount").val() > 0) {
                confirmSecondCurrency = $("#sell-amount").val() + ' ' + $("#sell-currency").val() + '</strong> each'
            } else {
                confirmSecondCurrency = '0 ' + $("#sell-currency").val() + '</strong>'
            }
            if ($("#sell-enddate").val() > 1) {
                confirmSecondDate = $("#sell-enddate").val() + ' days'
            } else {
                confirmSecondDate = $("#sell-enddate").val() + ' day'
            }
            contentBootboxConfirm = 'You are going to sell <strong>' + confirmSecondQty + '</strong> for <strong>' + confirmSecondCurrency + ', for a duration of <strong>' + confirmSecondDate + '</strong>.<br>Do you want to confirm?<br><br><i><span style="font-size:.7em;">Your ' + confirmSecondDesc + ' will show up on the marketplace within 3 minutes.</span></i>'

            dialogConfirm = bootbox.confirm({
                title: "NFT sell confirmation",
                message: contentBootboxConfirm,
                buttons: {
                    cancel: {
                        label: '<i class="fa fa-times"></i> Cancel',
                        className:'btn btn-default'
                    },
                    confirm: {
                        label: '<i class="fa fa-check"></i> Confirm & sell ' + confirmSecondBtn,
                        className:'btn btn-primary sell-confirm'
                    }
                },
                callback: function(result) {

                  if (result) {

                    confirmSellNFT(nftIdArr, sellAmount, sellCurrency, endDate)

                  } else {
                    confirmSellInitial();
                  }

                }

              })

          } else {
            $('#sendSpinner').hide();
          }

        }

      }).init(function() {

        // Trigger next button on press enter
        var input = document.getElementById("sell-amount");
        input.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                event.preventDefault();
                document.getElementById("sell-confirm").click();
            }
        });

        // On sort by change event
        $("#sell-sort").change(function () {

          if (document.getElementById("sorting-order-modal-down")) {
            triggerSort(true);
          } else {
            triggerSort(false);
          }

        });

        // On select nft change event
        $("#select-nft").bind("keydown change", function(){

          document.getElementById("selected-nfts").innerHTML = $("#select-nft :checked").length;

         });

        // On filter type change event
        $("#sell-type-filter").change(function () {

          $("#select-nft").hide();
          $("#loader-nftlist-modal").show();

          // on change reset selected values & count
          $("#select-nft").val('');
          document.getElementById("selected-nfts").innerHTML = 0;

          // show all type on change start
          $("#select-nft option.filter-type").removeAttr('disabled').show();

          // show all rarity on change start & reset value
          $("#select-nft option.filter-rarity").removeAttr('disabled').show();
          $("#sell-rarity-filter").val("any");

             var e = document.getElementById("sell-type-filter");
             var type = e.options[e.selectedIndex].value;

             function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            // set filter sell
            filterSell = type;

            // if any, show all
            if (type == 'any') {
              $("#select-nft option.filter-type").removeAttr('disabled').show();
              document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type").length;
            } else if (type == 'part') {
              $("#select-nft option:not(.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + "):not(.filter-type.filter-type-Pack)").attr('disabled', 'disabled').hide();
              document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase())).length + $("#select-nft option.filter-type.filter-type-Pack").length;
            } else {
              $("#select-nft option:not(.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
              document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase())).length;
            }
            $("#loader-nftlist-modal").hide();
            if (document.getElementById("available-nfts").innerHTML == '0') {
              $("#select-nft").hide();
              $("#filter-results-count").hide();
            } else {
              $("#select-nft").show();
              $("#filter-results-count").show();
            }

         });

        // On filter rarity change event
        $("#sell-rarity-filter").change(function () {

          $("#select-nft").hide();
          $("#loader-nftlist-modal").show();

          // on change reset selected values & count
          $("#select-nft").val('');
          document.getElementById("selected-nfts").innerHTML = 0;

          // show all type on change start
          $("#select-nft option.filter-type").removeAttr('disabled').show();

          // handle change rarity if type has not been changed yet
          if (typeof filterSell == 'undefined') {
            filterSell = 'any';
          }

          // show all on change start
          if (filterSell != 'any') {
            $("#select-nft option:not(.filter-type-" + capitalizeFirstLetter(filterSell.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
            $("#select-nft option.filter-type-" + capitalizeFirstLetter(filterSell.toLowerCase())).removeAttr('disabled').show();
          }

             var e = document.getElementById("sell-rarity-filter");
             var rarity = e.options[e.selectedIndex].value;

             function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }

            // if any, show all
            if (rarity == 'any') {
              if (filterSell == 'any') {
                document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type").length;
              } else if (filterSell == 'part') {
                document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type.filter-type-" + capitalizeFirstLetter(filterSell.toLowerCase())).length + $("#select-nft option.filter-type.filter-type-Pack").length;
              } else {
                document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-type.filter-type-" + capitalizeFirstLetter(filterSell.toLowerCase())).length;
              }
            } else {
              if (filterSell == 'any') {
                $("#select-nft option:not(.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
                document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase())).length;
              } else {
                $("#select-nft option:not(.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
                document.getElementById("available-nfts").innerHTML = $("#select-nft option.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase())).filter(".filter-type-" + capitalizeFirstLetter(filterSell.toLowerCase())).length;
              }
            }
            $("#loader-nftlist-modal").hide();
            if (document.getElementById("available-nfts").innerHTML == '0') {
              $("#select-nft").hide();
              $("#filter-results-count").hide();
            } else {
              $("#select-nft").show();
              $("#filter-results-count").show();
            }

         });
        // init custom dropdown after bootbox init
        //$("#select-nft-custom").msDropDown();
      });

  }

}

// Confirm sell nft
function confirmSellNFT(nftIdArr, priceNFT, quoteSymbol, endDate) {

  var now = new Date();
  endDateFormatted = now.getTime() + (endDate*86400000)
  params = [];
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: ''  }
  params[1] = { name: 'baseSymbol', type: 'String', input: 'TTRS', info: '' },
  params[2] = { name: 'quoteSymbol', type: 'String', input: quoteSymbol, info: '' },
  params[3] = { name: 'tokenID', type: 'Number', input: nftIdArr[0].id, info: '' },
  params[4] = { name: 'price', type: 'Number', input: priceNFT*(Math.pow(10,formatDecimals(quoteSymbol))), info: '' },
  //params[5] = { name: 'endDate', type: 'Timestamp', input: '03/07/2020 00:00:00', info: '' }
  params[5] = { name: 'endDate', type: 'TimestampEpoch', input: endDateFormatted, info: '' }

  //$.post('/contract/tx',
  $.post('/confirmsellnft',
     /*{
         chain: 'main',
         contract: 'market',
         method: 'SellToken',
         params: JSON.stringify({
           params
         })
     },*/
     {
         chain: 'main', contract: 'market', method: 'SellToken', params: JSON.stringify({params}), id: JSON.stringify(nftIdArr)
     },
     function (returnedData) {
         if (returnedData !== "") {
           for (var i = 0, len = nftIdArr.length; i < len; i++) {
             pendingItems.push ({
                 id: nftIdArr[i]
             });
           }
           $('#sendSpinner').hide();
           alertbox.show('Transaction successful!');
           itemBought = 1;
           refreshAuctions();
         } else {
           window.location.replace("/error");
         }
         console.log(returnedData);
     }).fail(function() {
     $('#sendSpinner').hide();
     console.log("error marketplace");
     })

}

// Initiate buy nft
function initiateBuy() {

  if (lenAuctionsBuy == 0 || lenAuctionsBuy == null) {
        bootbox.alert("There are no NFTs available to buy!");
        return;
  }

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
        bootbox.alert("Not enough KCAL available. You need at least 0.1 KCAL to perform a transaction!");
        return;
  }

  confirmBuyInitial();

  function confirmBuyInitial() {

  $('#sendSpinner').show();

  contentBootbox = '1) Select the NFT(s) you would like to buy:<br><i><span style="font-size:.7em;">You can select multiple NFT(s) by pressing shift/control.</span></i><br><br>'
                + '<div class="filter-results">Currency: <select style="margin-left:.5em;margin-right:1em;height: 2.5em;text-transform:uppercase;" id="buy-currency-filter"><option value="SOUL">SOUL</option><option value="KCAL">KCAL</option><option value="GOATI">GOATI</option></select>'
                + 'Type: <select style="margin-left:.5em;margin-right:1em;display:inline-block;height: 2.5em;text-transform:uppercase;display:inline-block;" id="buy-type-filter"><option value="any">Any</option><option value="myItems">My Items</option><option value="license">Game Access</option><option value="part">Vehicle Parts</option><option value="vehicle">Vehicles</option></select>'
                + 'Rarity: <select style="margin-left:.5em;margin-right:1em;display:inline-block;height: 2.5em;text-transform:uppercase;" id="buy-rarity-filter"><option value="any">Any</option><option value="consumer">Consumer</option><option value="industrial">Industrial</option><option value="professional">Professional</option><option value="custom">Custom</option><option value="collector">Collector</option><option value="unique">Unique</option></select>'
                + 'Sort by: <select style="margin-left:.5em;margin-right:1em;height: 2.5em;text-transform:uppercase;" id="buy-sort"><option value="item">Item</option><option value="price">Price</option><option value="mint">Mint #</option><option value="rarity">Rarity</option></select>'
                + '<span id="sorting-order-container-modal"><i id="sorting-order-modal-down" onclick="sortTypeModal()" class="fas fa-sort-numeric-down"></i></span></div>'
                + '<div class="filter-results-count">There are <strong><span id="available-nfts-buy">' + lenAuctionsBuy + '</span> NFTs available</strong> matching these filters.</div>'
                + fetchBuyNFTDropdown
                + '<div class="filter-results-count" id="filter-results-count-selected">You have selected <span id="selected-nfts-buy-count"><strong>0 NFTs </strong> to be bought.</span></div><br>'
                + '2) Confirm the total amount to be spent:<br><br>'
                + '<div class="filter-results-count">You will be paying a total of <span id="selected-nfts-buy-amount"><strong>0 SOUL</strong> to buy these NFT(s).</span></div><br>'

  dialog = bootbox.confirm({
      title: "NFT buy selection",
      message: contentBootbox,
      buttons: {
          cancel: {
              label: '<i class="fa fa-times"></i> Cancel',
              className:'btn btn-default'
          },
          confirm: {
              label: '<i class="fa fa-check"></i> Buy NFT',
              className:'btn btn-primary sell-confirm'
          }
      },
      callback: function(result) {

        //$("#select-id").msDropDown();

        if (result) {

          quoteSymbol = $("#buy-currency-filter").val();
          bulkdIdNFT = $("#select-nft-buy").val();

          nftIdArr = [];
          for (var i = 0; i < bulkdIdNFT.length; i++) {
            nftIdArr.push ({
                id: bulkdIdNFT[i]
            });
          }

          creatorAddress = []
          $("#select-nft-buy option:selected[creatorAddress]").each(function() {
                creatorAddress.push ({
                    id: $(this).attr("creatorAddress")
                });
          });

          priceNFT = []
          $("#select-nft-buy option:selected[price]").each(function() {
                priceNFT.push ({
                    id: $(this).attr("price")
                });
          });

          // second confirm
          if ($("#select-nft-buy :checked").length > 1) {
              confirmSecondQty = $("#select-nft-buy :checked").length + ' NFTs'
              confirmSecondBtn = 'NFTs'
              confirmSecondDesc = 'NFTs'
          } else {
              confirmSecondQty = $("#select-nft-buy :checked").length + ' NFT'
              confirmSecondBtn = 'NFT'
              confirmSecondDesc = 'NFT'
          }
          // if only cancel items
          if (totalAmount == 0) {
            confirmSecondCurrency = ''
            confirmSecondAction = 'cancel the sale of'
            confirmSecondBtnAction = ' Confirm & cancel '
          } else {
            confirmSecondCurrency = ' for <strong>' + numberWithCommas(totalAmount) + ' ' + ($("#buy-currency-filter").val()).toUpperCase() + ' (and a 2% fee: ' + numberWithCommas(finalFee) + ' ' + ($("#buy-currency-filter").val()).toUpperCase() + '</strong>)'
            confirmSecondAction = 'buy'
            confirmSecondBtnAction = ' Confirm & buy ';
          }
          contentBootboxConfirm = 'You are going to ' + confirmSecondAction + ' <strong>' + confirmSecondQty + '</strong>' + confirmSecondCurrency + '.<br>Do you want to confirm?<br><br><i><span style="font-size:.7em;">The ' + confirmSecondDesc + ' will show up in your portfolio within 10 seconds.</span></i>'

          dialogConfirm = bootbox.confirm({
              title: "NFT buy confirmation",
              message: contentBootboxConfirm,
              buttons: {
                  cancel: {
                      label: '<i class="fa fa-times"></i> Cancel',
                      className:'btn btn-default'
                  },
                  confirm: {
                      label: '<i class="fa fa-check"></i>' + confirmSecondBtnAction + confirmSecondBtn,
                      className:'btn btn-primary sell-confirm'
                  }
              },
              callback: function(result) {

                if (result) {

                  confirmBuyNFTModal(quoteSymbol, nftIdArr, priceNFT, creatorAddress)

                } else {
                  confirmBuyInitial();
                }

              }

            })

        } else {
          $('#sendSpinner').hide();
        }

      }

    }).init(function() {

      currency = 'SOUL';

      var e = document.getElementById("buy-currency-filter");
      currency = e.options[e.selectedIndex].value;

      $("#select-nft-buy option.filter-currency").removeAttr('disabled').show();
      $("#select-nft-buy option:not(.filter-currency.filter-currency-" + currency + ")").attr('disabled', 'disabled').hide();
      document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-currency-" + currency).length;

      // On select nft change event
      $("#select-nft-buy").bind("keydown change", function(){

        totalAmount = 0
        $("#select-nft-buy option:selected[price]").each(function() {
            totalAmount += parseFloat($(this).attr("price"))
        });
        buyerFee = 0.02;
        if (roundDown((totalAmount*buyerFee),2) < 0.10) {
          finalFee = 0.1
        } else {
          finalFee = roundDown((totalAmount*buyerFee),2);
        }

        // if only cancel items
        if (totalAmount == 0) {
          document.getElementById("selected-nfts-buy-count").innerHTML = '<strong>' + $("#select-nft-buy :checked").length + ' NFTs </strong> to be cancelled.';
          document.getElementById("selected-nfts-buy-amount").innerHTML = '<strong>' + numberWithCommas(totalAmount) + ' ' + ($("#buy-currency-filter").val()).toUpperCase() + ' (and 0% fee)' + '</strong> to cancel these NFT(s).</span>'
        } else {
          document.getElementById("selected-nfts-buy-count").innerHTML = '<strong>' + $("#select-nft-buy :checked").length + ' NFTs </strong> to be bought.';
          document.getElementById("selected-nfts-buy-amount").innerHTML = '<strong>' + numberWithCommas(totalAmount) + ' ' + ($("#buy-currency-filter").val()).toUpperCase() + ' (and a 2% fee: ' + numberWithCommas(finalFee) + ' ' + ($("#buy-currency-filter").val()).toUpperCase() + ')' + '</strong> to buy these NFT(s).</span>'
        }

       });

       // On sort by change event
       $("#buy-sort").change(function () {

         if (document.getElementById("sorting-order-modal-down")) {
           triggerSort(true);
         } else {
           triggerSort(false);
         }

       });

       // On filter currency change event
       $("#buy-currency-filter").change(function () {

         $("#select-nft-buy").hide();
         $("#loader-nftlist-modal").show();

         // on change reset selected values & count
         $("#select-nft-buy").val('');
         document.getElementById("selected-nfts-buy-count").innerHTML = '<strong>0 NFTs </strong> to be bought.';

         // show all type on change start
         $("#select-nft-buy option.filter-type").removeAttr('disabled').show();

         var e = document.getElementById("buy-currency-filter");
         currency = e.options[e.selectedIndex].value;

         $("#select-nft-buy option.filter-currency").removeAttr('disabled').show();
         $("#select-nft-buy option:not(.filter-currency.filter-currency-" + currency + ")").attr('disabled', 'disabled').hide();
         document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-currency-" + currency).length;

         $("#buy-type-filter").val("any");
         $("#buy-rarity-filter").val("any");

         $("#select-nft-buy").show();
         $("#loader-nftlist-modal").hide();

      });

      // On filter type change event
      $("#buy-type-filter").change(function () {

        $("#select-nft-buy").hide();
        $("#loader-nftlist-modal").show();

        // on change reset selected values & count
        $("#select-nft-buy").val('');
        document.getElementById("selected-nfts-buy-count").innerHTML = '<strong>0 NFTs </strong> to be bought.';

        // show all type on change start
        $("#select-nft-buy option.filter-type").removeAttr('disabled').show();

        var e = document.getElementById("buy-currency-filter");
        currency = e.options[e.selectedIndex].value;

        // show all rarity on change start & reset value
        $("#select-nft-buy option.filter-rarity").removeAttr('disabled').show();
        $("#buy-rarity-filter").val("any");

        // switch back to currency on start
        $("#select-nft-buy option.filter-currency").removeAttr('disabled').show();
        $("#select-nft-buy option:not(.filter-currency.filter-currency-" + currency + ")").attr('disabled', 'disabled').hide();
        $("#buy-currency-filter").val(currency);

           var e = document.getElementById("buy-type-filter");
           var type = e.options[e.selectedIndex].value;

           function capitalizeFirstLetter(string) {
              return string.charAt(0).toUpperCase() + string.slice(1);
          }

          // set filter buy
          filterBuy = type;

          // if any, show all
          if (type == 'any') {
            $("#select-nft-buy option.filter-type").removeAttr('disabled').show();
            document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type:not(.filter-currency-" + currency + ")").length;
          } else if (type == 'part') {
            $("#select-nft-buy option:not(.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + "):not(.filter-type.filter-type-Pack)").attr('disabled', 'disabled').hide();
            document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + ":not(.filter-currency-" + currency + ")").length + $("#select-nft-buy option.filter-type.filter-type-Pack :not(.filter-currency-" + currency + ")").length;
          } else if (type == 'license') {
            $("#select-nft-buy option:not(.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
            document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase())).filter(".filter-currency-" + currency).length;
          } else if (type == 'myItems') {
            $("#select-nft-buy option:not(.filter-" + type + ")").attr('disabled', 'disabled').hide();
            document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-" + type).filter(".filter-currency-" + currency).length;
          } else {
            $("#select-nft-buy option:not(.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
            document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type.filter-type-" + capitalizeFirstLetter(type.toLowerCase()) + ":not(.filter-currency-" + currency + ")").length;
          }
          $("#select-nft-buy option:not(.filter-currency.filter-currency-" + currency + ")").attr('disabled', 'disabled').hide();
          $("#loader-nftlist-modal").hide();
          if (document.getElementById("available-nfts-buy").innerHTML == '0') {
            $("#select-nft-buy").hide();
            $("#filter-results-count-selected").hide();
          } else {
            $("#select-nft-buy").show();
            $("#filter-results-count-selected").show();
          }

       });

      // On filter rarity change event
      $("#buy-rarity-filter").change(function () {

        $("#select-nft-buy").hide();
        $("#loader-nftlist-modal").show();

        // on change reset selected values & count
        $("#select-nft-buy").val('');
        document.getElementById("selected-nfts-buy-count").innerHTML = '<strong>0 NFTs </strong> to be bought.';

        // show all type on change start
        $("#select-nft-buy option.filter-type").removeAttr('disabled').show();

        var e = document.getElementById("buy-currency-filter");
        currency = e.options[e.selectedIndex].value;

        // switch back to currency on start
        $("#select-nft-buy option.filter-currency").removeAttr('disabled').show();
        $("#select-nft-buy option:not(.filter-currency.filter-currency-" + currency + ")").attr('disabled', 'disabled').hide();
        $("#buy-currency-filter").val(currency);

        // handle change rarity if type has not been changed yet
        if (typeof filterBuy == 'undefined') {
          filterBuy = 'any';
        }

        // show all on change start
        if (filterBuy != 'any') {
          if (filterBuy == 'myItems') {
            $("#select-nft-buy option:not(.filter-myItems)").attr('disabled', 'disabled').hide();
            $("#select-nft-buy option.filter-myItems").filter(".filter-currency-" + currency).removeAttr('disabled').show();
          } else {
            $("#select-nft-buy option:not(.filter-type-" + capitalizeFirstLetter(filterBuy.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
            $("#select-nft-buy option.filter-type-" + capitalizeFirstLetter(filterBuy.toLowerCase())).filter(".filter-currency-" + currency).removeAttr('disabled').show();
          }
        }

           var e = document.getElementById("buy-rarity-filter");
           var rarity = e.options[e.selectedIndex].value;

           function capitalizeFirstLetter(string) {
              return string.charAt(0).toUpperCase() + string.slice(1);
          }

          // if any, show all
          if (rarity == 'any') {
            if (filterBuy == 'any') {
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type").filter(".filter-currency-" + currency).length;
            } else if (filterBuy == 'part') {
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type.filter-type-" + capitalizeFirstLetter(filterBuy.toLowerCase())).filter(".filter-currency-" + currency).length + $("#select-nft-buy option.filter-type.filter-type-Pack").filter(".filter-currency-" + currency).length;
            } else if (filterBuy == 'myItems') {
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-" + type).filter(".filter-currency-" + currency).length;
            } else {
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-type.filter-type-" + capitalizeFirstLetter(filterBuy.toLowerCase())).filter(".filter-currency-" + currency).length;
            }
          } else {
            if (filterBuy == 'any') {
              $("#select-nft-buy option:not(.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase())).filter(".filter-currency-" + currency).length;
            } else if (filterBuy == 'myItems') {
              $("#select-nft-buy option:not(.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
                document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase())).filter(".filter-" + filterBuy).filter(".filter-currency-" + currency).length;
            } else {
              $("#select-nft-buy option:not(.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase()) + ")").attr('disabled', 'disabled').hide();
              document.getElementById("available-nfts-buy").innerHTML = $("#select-nft-buy option.filter-rarity.filter-rarity-" + capitalizeFirstLetter(rarity.toLowerCase())).filter(".filter-type-" + capitalizeFirstLetter(filterBuy.toLowerCase())).filter(".filter-currency-" + currency).length;
            }
          }
          $("#loader-nftlist-modal").hide();
          if (document.getElementById("available-nfts-buy").innerHTML == '0') {
            $("#select-nft-buy").hide();
            $("#filter-results-count-selected").hide();
          } else {
            $("#select-nft-buy").show();
            $("#filter-results-count-selected").show();
          }

       });

    });

  }

}

// On sort order click
function sortTypeModal() {

  if (document.getElementById("sorting-order-modal-down")) {
    document.getElementById("sorting-order-container-modal").innerHTML = '<i id="sorting-order-modal-up" onclick="sortTypeModal()" class="fas fa-sort-numeric-up"></i></span></div>'
    triggerSort(false)
  } else {
    document.getElementById("sorting-order-container-modal").innerHTML = '<i id="sorting-order-modal-down" onclick="sortTypeModal()" class="fas fa-sort-numeric-down"></i></span></div>'
    triggerSort(true)
  }

}

function triggerSort(orderAsc) {

  if (orderAsc) {

    if (document.getElementById("buy-sort")) {
      var e = document.getElementById("buy-sort");
      var type = e.options[e.selectedIndex].value;
      var select = $('#select-nft-buy');
    } else {
      var e = document.getElementById("sell-sort");
      var type = e.options[e.selectedIndex].value;
      var select = $('#select-nft');
    }

    if (type == 'item') {

      select.html(select.find('option').sort(function(x, y) {

        if (parseFloat($(x).attr("item")) < parseFloat($(y).attr("item"))) return 1;
        if (parseFloat($(x).attr("item")) > parseFloat($(y).attr("item"))) return -1;

        if (parseFloat($(x).attr("mint")) > parseFloat($(y).attr("mint"))) return 1;
        if (parseFloat($(x).attr("mint")) < parseFloat($(y).attr("mint"))) return -1;

      }));

    } else if (type == 'price') {

      select.html(select.find('option').sort(function(x, y) {
        return parseFloat($(x).attr("priceReal")) > parseFloat($(y).attr("priceReal")) ? 1 : -1;
      }));

    } else if (type == 'mint') {

      select.html(select.find('option').sort(function(x, y) {
        return parseFloat($(x).attr("mint")) > parseFloat($(y).attr("mint")) ? 1 : -1;
      }));

    } else if (type == 'rarity') {

      item_order = ["Common","Consumer","Industrial","Professional","Custom","Collector","Unique"];

      select.html(select.find('option').sort(function(x, y) {
        return item_order.indexOf($(x).attr("rarity")) > item_order.indexOf($(y).attr("rarity")) ? 1 : -1;
      }));

    }

  } else {

    if (document.getElementById("buy-sort")) {
      var e = document.getElementById("buy-sort");
      var type = e.options[e.selectedIndex].value;
      var select = $('#select-nft-buy');
    } else {
      var e = document.getElementById("sell-sort");
      var type = e.options[e.selectedIndex].value;
      var select = $('#select-nft');
    }

    if (type == 'item') {

      select.html(select.find('option').sort(function(x, y) {

        if (parseFloat($(x).attr("item")) > parseFloat($(y).attr("item"))) return 1;
        if (parseFloat($(x).attr("item")) < parseFloat($(y).attr("item"))) return -1;

        if (parseFloat($(x).attr("mint")) > parseFloat($(y).attr("mint"))) return 1;
        if (parseFloat($(x).attr("mint")) < parseFloat($(y).attr("mint"))) return -1;

      }));

    } else if (type == 'price') {

      select.html(select.find('option').sort(function(x, y) {
        return parseFloat($(x).attr("priceReal")) < parseFloat($(y).attr("priceReal")) ? 1 : -1;
      }));

    } else if (type == 'mint') {

      select.html(select.find('option').sort(function(x, y) {
        return parseFloat($(x).attr("mint")) < parseFloat($(y).attr("mint")) ? 1 : -1;
      }));

    } else if (type == 'rarity') {

      item_order = ["Common","Consumer","Industrial","Professional","Custom","Collector","Unique"];

      select.html(select.find('option').sort(function(x, y) {
        return item_order.indexOf($(x).attr("rarity")) < item_order.indexOf($(y).attr("rarity")) ? 1 : -1;
      }));

    }

  }

}

// Confirm sell nft
function confirmBuyNFTModal(quoteSymbol, nftIdArr, priceNFT, creatorAddress) {

  params = [];
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: ''  }
  params[1] = { name: 'symbol', type: 'String', input: 'TTRS', info: '' },
  params[2] = { name: 'tokenID', type: 'Number', input: nftIdArr[0].id, info: '' }

  $.post('/marketbuycustommodal',
     {
         chain: 'main',
         contract: 'market',
         method: 'BuyToken',
         params: JSON.stringify({
           params
         }),
         id: JSON.stringify(nftIdArr),
         quoteSymbol: quoteSymbol,
         priceNFT: JSON.stringify(priceNFT),
         creatorAddress : JSON.stringify(creatorAddress)
     },
     function (returnedData) {
         if (returnedData !== "") {
             for (var i = 0, len = nftIdArr.length; i < len; i++) {
               pendingItems.push ({
                   id: nftIdArr[i]
               });
             }
             $('#sendSpinner').hide();
             alertbox.show('Transaction successful!');
             itemBought = 1;
             refreshAuctions();
         } else {
             window.location.replace("/error");
         }
         console.log(returnedData);
     }).fail(function() {
     $('#sendSpinner').hide();
     console.log("error marketplace");
     })

}

</script>
