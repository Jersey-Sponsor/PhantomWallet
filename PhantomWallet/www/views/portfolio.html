<script src="https://code.highcharts.com/stock/highstock.js"></script>
<script src="https://unpkg.com/datatables.net@1.10.19/js/jquery.dataTables.min.js"></script>
<h3 class="tab-title">Portfolio</h3>
{{#if holdings}}
<div class="portfolio">
  <div class="top-portfolio col-md-12">
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/kcal_logo.png" /><span>ENERGY</span><br><span id="unclaimed-kcal" class="top-portfolio-col-highlight">KCAL</span><br><span id="rewards-kcal" class="top-portfolio-col-small">KCAL / DAY</span></div>
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/phantasma_logo.png" /><span>STAKES</span><br><span id="stake-soul" class="top-portfolio-col-highlight">SOUL</span><br><span id="rewards-soulmasters" class="top-portfolio-col-small">SOUL / MONTH</span></div>
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/soulmasters_logo.png" /><span>SOULMASTERS</span><br><span><span id="count-soulmasters" class="top-portfolio-col-highlight">SOULMASTER</span></span><br><span><span id="count-soulmasters-total" class="top-portfolio-col-small">OUT OF SOULMASTER</span></span></div>
</div>
    <div class="wrapper-portfolio">
      <div><button type="button" class="button" onclick="Claim()">CLAIM<BR>KCAL</button></div>
      <div><input id="manageinput" type="number" min="1" class="form-control " placeholder="Amount" style="display:inline-block;text-align:center;width: 22%;display:inline-block;margin-right: 1em;"><button type="button" class="button" style="border-radius: 0;" onclick="Stake()">STAKE</button><button type="button" class="button" style="border-radius: 0;margin-left: .1em;" onclick="Unstake()">UNSTAKE</button></div>
      <div><button type="button" class="button"onclick="MasterClaim()">CLAIM<BR>REWARDS</button></div>
    </div>
    <div id="wrapper-portfolio-confirm">
    </div>
  <div class="table-responsive col-md-12">
      <table class="table table-general" id="mainportfoliotable">
          <thead>
              <tr>
                  <th class="col-6">ASSET NAME</th>
                  <th class="col-6">CHAIN NAME</th>
                  <th class="col-3">ASSET QUANTITY</th>
                  <th class="col-3" id="currency-header">VALUE</th>
              </tr>
          </thead>
          <tbody>
              {{#each holdings}}
              <tr class="token-shadow">
                  {{#if Symbol == 'SOUL'}}
                    <td class="col-6"><img class="token-icon" src="img/{{Icon}}.png" />{{Name}} - <a href="http://localhost:7072/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                  {{#else}}
                    <td class="col-6"><img class="token-icon" src="img/soulmasters_logo.png" />{{Name}} - <a href="http://localhost:7072/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                  {{/if}}
                  <td class="col-6">{{ChainName}}</td>
                  <td class="col-3">{{AmountFormated}}</td>
                  {{#if Symbol == 'SOUL'}}
                    <td class="col-3">{{CurrencySymbol}}{{PriceFormated}}</td>
                  {{#else}}
                    <td class="col-3">N/A</td>
                  {{/if}}
              </tr>
              {{/each}}
            </tbody>
            <tfoot>
              <tr class="token-shadow">
                <td class="col-6">TOTAL</td>
                <td class="col-6"></td>
                <td class="col-3"></td>
                <td class="col-3" id="totalportfolio"></td>
              </tr>
          </tfoot>
      </table>
  </div>
  <div id="wrapper" style="margin:0 auto;">
  <div id="container-pie" style="height:370px" class="col-md-6"></div>
  <div id="container-historical-value" style="height:370px" class="col-md-4"></div>
  </div>
</div>
<div class="multisig-event">
  <i class="fas fa-exclamation-circle" onclick="console.log('trigger popup event')" ></i><br>
  <span>NEW<br>EVENT</span>
</div>
<script>

    $(document).ready(function() {

      if (localStorage.getItem('currency') !== 'null') {
        currency = localStorage.getItem('currency');
        if (localStorage.getItem('currency') == 'EUR') {
          currencysymbol = '€';
        } else if (localStorage.getItem('currency') == 'CAD') {
          currencysymbol = 'C$';
        } else if (localStorage.getItem('currency') == 'GBP') {
          currencysymbol = '£';
        } else if (localStorage.getItem('currency') == 'JPY') {
          currencysymbol = '¥';
        } else if (localStorage.getItem('currency') == 'AUD') {
          currencysymbol = 'A$';
        } else {
          currencysymbol = '$';
        }
      } else {
        currency = 'USD';
        currencysymbol = '$';
      }
      document.getElementById("currency-header").innerHTML = currency + ' VALUE';

      getContainerPie();
      getUnclaimed();
      getStake();
      GetSoulmastersDetails();
      initTables();

      var pathname = window.location.pathname;
      if (pathname != '/login' && pathname != '/create') {
        setInterval(function() {
          getUnclaimed();
          getStake();
          GetSoulmastersDetails();
        }, 60000);
      }

    });

    function initTables() {
        if (!$.fn.dataTable.isDataTable('#mainportfoliotable')) {
            setTimeout(function() {
                jQuery.extend(jQuery.fn.dataTableExt.oSort, {
                    "currency-pre": function(a) {
                        a = (a === "-") ? 0 : a.replace(/[^\d\-\.]/g, "");
                        return parseFloat(a)
                    },
                    "currency-asc": function(a, b) {
                        return a - b
                    },
                    "currency-desc": function(a, b) {
                        return b - a
                    }
                });
                $('#mainportfoliotable').DataTable({
                    "order": [
                        [3, "desc"]
                    ],
                    "language": {
                        "decimal": ".",
                        "thousands": ","
                    },
                    "bPaginate": !1,
                    "aaSorting": [],
                    "columnDefs": [{
                        type: 'currency',
                        targets: [3]
                    }],
                    "initComplete": function() {
                        $(this).show()
                    }
                })
            }, 100)
        }
    }

    function getUnclaimed() {

      var params = [];
      params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

      $.post('/contract',
         {
             chain: 'main',
             contract: 'energy',
             method: 'GetUnclaimed',
             params: JSON.stringify({
               params
             })
         },
         function (returnedData) {
             unclaimedFormatted = (returnedData) / (Math.pow(10, 10));
             if (document.getElementById("unclaimed-kcal").innerHTML != numberWithCommas(unclaimedFormatted) + ' KCAL') {
               document.getElementById("unclaimed-kcal").innerHTML = numberWithCommas(toFixed(unclaimedFormatted)) + ' KCAL';
               $(document.getElementById("unclaimed-kcal")).addClass('flash-portfolio').delay(300).queue(function(next){
                    $(this).removeClass('flash-portfolio');
                    next();
               });
             }
         }).fail(function(e) {
            console.log(e)
         })

    }

    function Claim() {

      var params = [];
      params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
      params[1] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

      $.post('/contract/tx',
         {
             chain: 'main',
             contract: 'energy',
             method: 'Claim',
             params: JSON.stringify({
               params
             })
         },
         function (returnedData) {
              console.log(returnedData)
              document.getElementById("wrapper-portfolio-confirm").innerHTML = returnedData;
         }).fail(function(e) {
            console.log(e)
         })

         setTimeout(function() {
           getUnclaimed();
         }, 2000);

    }

    function getStake() {

      var params = [];
      params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

      $.post('/contract',
         {
             chain: 'main',
             contract: 'energy',
             method: 'GetStake',
             params: JSON.stringify({
               params
             })
         },
         function (returnedData) {
            stakesFormatted = (returnedData) / (Math.pow(10, 8));
            if (document.getElementById("stake-soul").innerHTML != numberWithCommas(stakesFormatted) + ' SOUL') {
              document.getElementById("stake-soul").innerHTML = numberWithCommas(stakesFormatted) + ' SOUL';
              $(document.getElementById("stake-soul")).addClass('flash-portfolio').delay(300).queue(function(next){
                   $(this).removeClass('flash-portfolio');
                   next();
              });
            }
            if (document.getElementById("rewards-kcal").innerHTML != numberWithCommas(stakesFormatted/500) + ' KCAL / DAY') {
              document.getElementById("rewards-kcal").innerHTML = numberWithCommas(stakesFormatted/500) + ' KCAL / DAY';
              $(document.getElementById("rewards-kcal")).addClass('flash-portfolio').delay(300).queue(function(next){
                   $(this).removeClass('flash-portfolio');
                   next();
              });
            }
         }).fail(function(e) {
            console.log(e)
         })

    }

    function Stake() {

      var params = [];
      fetchValuesManage = '';
      params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
      params[1] = { name: 'stakeAmount', type: 'Number', input: toFixed((document.getElementById("manageinput").value)*(Math.pow(10,8))), info: '' }

      $.post('/contract/tx',
         {
             chain: 'main',
             contract: 'energy',
             method: 'Stake',
             params: JSON.stringify({
               params
             })
         },
         function (returnedData) {
            console.log(returnedData)
            document.getElementById("wrapper-portfolio-confirm").innerHTML = returnedData;
         }).fail(function(e) {
            console.log(e)
            document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
         })

         setTimeout(function() {
           getStake();
           setTimeout(function() {
             GetSoulmastersDetails();
           }, 1000);
         }, 2000);

    }

    function Unstake() {

      var params = [];
      params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
      params[1] = { name: 'stakeAmount', type: 'Number', input: toFixed((document.getElementById("manageinput").value)*(Math.pow(10,8))), info: '' }

      $.post('/contract/tx',
         {
             chain: 'main',
             contract: 'energy',
             method: 'Unstake',
             params: JSON.stringify({
               params
             })
         },
         function (returnedData) {
            console.log(returnedData)
            document.getElementById("wrapper-portfolio-confirm").innerHTML = returnedData;
         }).fail(function(e) {
            console.log(e)
            document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
         })

    }

    function GetSoulmastersDetails() {

      var params = [];
      var params2 = [];

      $.when(

        $.post('/contract',
           {
               chain: 'main',
               contract: 'energy',
               method: 'GetCurrentMasterCount',
               params: JSON.stringify({
                 params
               })
           },
           function (returnedData) {
              mastertotalcount = returnedData;
           }).fail(function(e) {
              console.log(e)
           }),

         params2[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' },

         $.post('/contract',
            {
                chain: 'main',
                contract: 'energy',
                method: 'GetStake',
                params: JSON.stringify({
                  params2
                })
            },
            function (returnedData) {
               stakeamount = returnedData;
            }).fail(function(e) {
               console.log(e)
            })

         ).then(function() {
           mastercount = Math.floor(stakeamount/(Math.pow(10,8))/50000);
           if (mastertotalcount > 0) {
             rewards = 125000/mastertotalcount;
           } else {
             rewards = 0;
           }
           if (mastercount == 0 || mastercount == 1) {
             if (document.getElementById("count-soulmasters").innerHTML != mastercount + ' SOULMASTER') {
               document.getElementById("count-soulmasters").innerHTML = mastercount + ' SOULMASTER';
               $(document.getElementById("count-soulmasters")).addClass('flash-portfolio').delay(300).queue(function(next){
                    $(this).removeClass('flash-portfolio');
                    next();
               });
             }
           } else {
             if (document.getElementById("count-soulmasters").innerHTML != mastercount + ' SOULMASTERS') {
               document.getElementById("count-soulmasters").innerHTML = mastercount + ' SOULMASTERS';
               $(document.getElementById("count-soulmasters")).addClass('flash-portfolio').delay(300).queue(function(next){
                    $(this).removeClass('flash-portfolio');
                    next();
               });
             }
           }
           if (mastertotalcount == 0 || mastertotalcount == 1) {
             if (document.getElementById("count-soulmasters-total").innerHTML != 'OUT OF ' + mastertotalcount + ' SOULMASTER') {
               document.getElementById("count-soulmasters-total").innerHTML = 'OUT OF ' + mastertotalcount + ' SOULMASTER';
               $(document.getElementById("count-soulmasters-total")).addClass('flash-portfolio').delay(300).queue(function(next){
                    $(this).removeClass('flash-portfolio');
                    next();
               });
             }
           } else {
             if (document.getElementById("count-soulmasters-total").innerHTML != 'OUT OF ' + mastertotalcount + ' SOULMASTERS') {
               document.getElementById("count-soulmasters-total").innerHTML = 'OUT OF ' + mastertotalcount + ' SOULMASTERS';
               $(document.getElementById("count-soulmasters-total")).addClass('flash-portfolio').delay(300).queue(function(next){
                    $(this).removeClass('flash-portfolio');
                    next();
               });
             }
           }
           if (document.getElementById("rewards-soulmasters").innerHTML != numberWithCommas(rewards) + ' SOUL / MONTH') {
             document.getElementById("rewards-soulmasters").innerHTML = numberWithCommas(rewards) + ' SOUL / MONTH';
             $(document.getElementById("rewards-soulmasters")).addClass('flash-portfolio').delay(300).queue(function(next){
                  $(this).removeClass('flash-portfolio');
                  next();
             });
           }
         })

    }

    function getContainerPie() {

      valueTOTAL = 0;
      urlforcombined = 'https://api.o3.network/v1/historical?currency=' + currency;
      arraygraph = [];

      {{#each holdings}}
        if ('{{Symbol}}' == 'SOUL') {
          valueTOTAL += parseInt(('{{PriceFormated}}').replace(/,/g, ''));
        }
      {{/each}}

      {{#each holdings}}
        if ('{{Symbol}}' == 'SOUL') {
          urlforcombined = urlforcombined + '&{{Symbol}}={{AmountFormated}}';
          arraygraph.push({name: "{{Symbol}}", y: ({{PriceFormated}})/valueTOTAL, oldColor: "#E8E8E8", sliced: true})
        }
      {{/each}}

      document.getElementById("totalportfolio").innerHTML = currencysymbol + numberWithCommas(valueTOTAL.toFixed(0));

  Highcharts.chart('container-pie', {
      chart: {
          type: 'pie',
          style: {
              fontFamily: 'Rubik'
          }
      },
      credits: {
          enabled: !1
      },
      tooltip: {
          pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
      },
      plotOptions: {
          pie: {
              allowPointSelect: !0,
              cursor: 'pointer',
              depth: 30,
              colors: ['#E8E8E8', '#17B0E7', '#2f7ed8', '#434348', '#8bbc21', '#64E572', '#DDDF00', '#8085e9', '#f28f43', '#e4d354', '#f45b5b', '#77a1e5'],
              slicedOffset: 10,
              dataLabels: {
                  enabled: !0,
                  format: '{point.name}: {point.percentage:.2f} %',
                  style: {
                      textOutline: !1
                  }
              },
              states: {
                  hover: {
                      enabled: !1
                  },
                  inactive: {
                      opacity: 1
                  }
              },
              point: {
                  events: {
                      mouseOver: function() {
                          this.options.oldColor = this.color;
                          this.graphic.attr("fill", "#17B0E7");
                          var point = this,
                              points = this.series.points;
                          for (var key in points) {
                              if (points[key].sliced) {
                                  points[key].slice(!1)
                              }
                          }
                          if (!point.selected) {
                              point.slice(!0)
                          }
                      },
                      mouseOut: function() {
                          this.graphic.attr("fill", this.options.oldColor);
                          for (var key in this.points) {
                              if (this.points[key].sliced) {
                                  this.points[key].slice(!1)
                              }
                          }
                      }
                  }
              }
          }
      },
      series: [{
          title: 'test',
          type: 'pie',
          name: 'Portfolio',
          data: arraygraph
      }],
      title: {
          text: 'Portfolio composition',
          //text: '',
          style: {
              fontSize: '16px'
          }
      }
  })
  $.ajax({
      xhrFields: {
          withCredentials: !1
      },
      cache: !1,
      crossDomain: !0,
      type: 'GET',
      dataType: 'json',
      data: {},
      url: urlforcombined.replace(/\,/g,'') + '&i=3M',
      success: function(data) {
          var response = JSON.stringify(data);
          var parsedJson = JSON.parse(response);
          var positivebal = false;
          var ohlc = [],
              dataLength = parsedJson.result.data.data.length,
              i = dataLength - 1;
          for (i; i >= 0; --i) {
              ohlc.push([
                  (new Date(parsedJson.result.data.data[i].time).getTime()),
                  parsedJson.result.data.data[i].averageUSD
              ]);
              if (parsedJson.result.data.data[i].averageUSD >= 1) {
                positivebal = true;
              }
          }
          if (positivebal == true) {
            Highcharts.stockChart('container-historical-value', {
                chart: {
                    style: {
                        fontFamily: 'Rubik'
                    }
                },
                xAxis: {
                  type: 'datetime',
                  labels: {
                    formatter: function() {
                      return Highcharts.dateFormat('%e %b', this.value);
                    },
                  }
                },
                yAxis: {
                    labels: {
                        formatter: function() {
                            return currencysymbol + this.axis.defaultLabelFormatter.call(this);
                        }
                    },
                    opposite: false,
                    min: 0,
                    gridLineWidth: 0,
                    minorGridLineWidth: 0
                },
                navigator: {
                    enabled: false
                },
                scrollbar: {
                    enabled: false
                },
                rangeSelector: {
                    enabled: false
                },
                legend: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                exporting: {
                    enabled: false
                },
                plotOptions: {
                    area: {
                        fillColor: {
                            linearGradient: {
                                x1: 0,
                                y1: 0,
                                x2: 0,
                                y2: 1
                            },
                            stops: [
                                [0, '#17B0E7'],
                                [1, '#fff']
                            ]
                        },
                        marker: {
                            radius: 4
                        },
                        lineWidth: 3,
                        states: {
                            hover: {
                                lineWidth: 1
                            }
                        },
                        threshold: null
                    }
                },
                tooltip: {
                    shared: true,
                    split: false,
                    formatter: function() {
                        if (($("#historical-value").val()) == '24H') {
                          var s = Highcharts.dateFormat('%A, %b %d, %Y - %H:%M', this.x);
                        } else {
                          var s = Highcharts.dateFormat('%A, %b %d, %Y', this.x);
                        }
                        $.each(this.points, function(i, point) {
                            s += '<br/><span style="color:' + point.color + '">\u25CF</span> ' + point.series.name + ' <b>' + currencysymbol + Highcharts.numberFormat(point.y, 0, '.', ',') + '</b>';
                        });
                        return s;
                    }
                },
                series: [{
                    type: 'area',
                    name: 'Average Wallet Value:',
                    data: ohlc,
                    color: '#17B0E7',
                    fillColor: {
                        linearGradient: {
                            x1: 1,
                            y1: 1,
                            x2: 1,
                            y2: 1
                        },
                        stops: [
                            [0, '#fff'],
                            [1, '#fff']
                        ]
                    }
                }],
                title: {
                    text: 'Portfolio total ' + currency + ' value',
                    //text: '',
                    style: {
                        fontSize: '16px'
                    }
                }
            });
            $("#container-historical-value").fadeIn(1000);
          }
      },
      error: function(xhr, err) {
        //console.log(err)
      }
  });
}
</script>
{{#else}}
<div class="alert alert-info" role="alert">
    This address is still new and does not have any assets yet.
</div>

{{/if}}
