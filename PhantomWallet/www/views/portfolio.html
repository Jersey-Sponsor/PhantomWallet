<h3 class="tab-title">Portfolio</h3>
{{#if holdings}}
<div class="portfolio">
  <div id="sendSpinner" class="loading">Loading&#8230;</div>
  <div class="top-portfolio col-md-12">
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/kcal_logo.png" /><span>ENERGY</span><br><span id="unclaimed-kcal" class="top-portfolio-col-highlight">KCAL</span><br><span id="rewards-kcal" class="top-portfolio-col-small">KCAL / DAY</span></div>
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/soul_logo.png" /><span>STAKES</span><span id="count-soulmasters" class="top-portfolio-col-small"></span><br><span id="stake-soul" class="top-portfolio-col-highlight">SOUL</span><br><br></div>
    <div class="top-portfolio-col"><img class="portfolio-token-icon" src="img/token_logo.png" /><span>SOULMASTERS</span><br><span><span id="count-soulmasters-total" class="top-portfolio-col-highlight">SOULMASTERS</span></span><br><span><span id="eligible-soulmasters" class="top-portfolio-col-small">ELIGIBLE / SOUL PER SM</span><span id="rewards-soulmasters" class="top-portfolio-col-small"></span></span></div>
</div>
    <div class="wrapper-portfolio">
      <div><button type="button" id="claim-kcal" class="button button-disabled" onclick="Claim()">CLAIM<BR>KCAL</button></div>
      <div><input id="manageinput" type="number" min="1" class="form-control center" placeholder="Amount" style="display:inline-block;width: 30%;display:inline-block;margin-right: 1em;"><button type="button" class="button" style="border-radius: 0;" onclick="Stake()" id="stakebutton">STAKE</button><button type="button" id="unstake-soul" class="button" style="border-radius: 0;margin-left: .1em;display:none;" onclick="Unstake()">UNSTAKE</button></div>
      <div><button type="button" id="claim-rewards" class="button button-disabled"onclick="MasterClaim()">CLAIM<BR>REWARDS</button></div>
    </div>
    <div id="wrapper-portfolio-confirm" style="opacity:0;">
      Transaction
    </div>
  <div class="table-responsive col-md-12">
      <table class="table table-general" id="mainportfoliotable">
          <thead>
              <tr>
                  <th class="col-6">ASSET NAME</th>
                  <th class="col-6" style="display:none">CHAIN NAME</th>
                  <th class="col-3">ASSET QUANTITY</th>
                  <th class="col-3" id="currency-header">VALUE</th>
              </tr>
          </thead>
          <tbody>
              {{#each holdings}}
              <tr class="token-shadow">
                  {{#if Symbol == 'SOUL'}}
                  <td class="col-6 aligned-row"><img class="token-icon" src="img/soul_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                  {{#else}}
                    {{#if Symbol == 'KCAL'}}
                    <td class="col-6 aligned-row"><img class="token-icon" src="img/kcal_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                    {{#else}}
                      {{#if Symbol == 'NACHO'}}
                      <td class="col-6 aligned-row"><img class="token-icon" src="img/nacho_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                      {{#else}}
                        {{#if Symbol == 'MKNI'}}
                        <td class="col-6 aligned-row"><img class="token-icon" src="img/mkni_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                        {{#else}}
                          {{#if Symbol == 'GAS'}}
                          <td class="col-6 aligned-row"><img class="token-icon" src="img/gas_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                          {{#else}}
                          {{#if Symbol == 'NEO'}}
                            <td class="col-6 aligned-row"><img class="token-icon" src="img/neo_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                            {{#else}}
                            {{#if Symbol == 'TTRS'}}
                              <td class="col-6 aligned-row"><img class="token-icon" src="img/22rs_logo.png" /><a href="http://www.22series.com/inventory?address={{address}}" target="_blank">{{Name}}<a> - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a><i class="tooltip-nft fas fa-info-circle" style="margin-left:.5em;width:1em;display:none;" data-tooltip-content="#tooltip_nft" id="tooltip_nft_list"></i></td>
                              {{#else}}
                              {{#if Symbol == 'GOATI'}}
                                <td class="col-6 aligned-row"><img class="token-icon" src="img/goati_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                                {{#else}}
                                <td class="col-6 aligned-row"><img class="token-icon" src="img/token_logo.png" />{{Name}} - <a href="{{explorer}}/token/{{Symbol}}" target="_blank" title="View Asset">{{Symbol}}</a></td>
                                {{/if}}
                              {{/if}}
                            {{/if}}
                          {{/if}}
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  {{/if}}
                  <td class="col-6" style="display:none">{{ChainName}}</td>
                  <td class="col-3" id="{{Symbol}}-amount">{{AmountFormated}}</td>
                  {{#if Symbol == 'SOUL'}}
                    <td class="col-3" id="{{Symbol}}-price">{{CurrencySymbol}}{{PriceFormated}}</td>
                  {{#else}}
                    {{#if Symbol == 'KCAL'}}
                      <td class="col-3" id="{{Symbol}}-price">{{CurrencySymbol}}{{PriceFormated}}</td>
                    {{#else}}
                      {{#if Symbol == 'GOATI'}}
                        <td class="col-3" id="{{Symbol}}-price">{{CurrencySymbol}}{{PriceFormated}}</td>
                      {{#else}}
                      {{#if Symbol == 'GAS'}}
                        <td class="col-3" id="{{Symbol}}-price">{{CurrencySymbol}}{{PriceFormated}}</td>
                      {{#else}}
                      {{#if Symbol == 'NEO'}}
                        <td class="col-3" id="{{Symbol}}-price">{{CurrencySymbol}}{{PriceFormated}}</td>
                      {{#else}}
                        <td class="col-3" id="{{Symbol}}-price">N/A</td>
                      {{/if}}
                      {{/if}}
                      {{/if}}
                    {{/if}}
                  {{/if}}
              </tr>
              {{/each}}
            </tbody>
            <tfoot>
              <tr class="token-shadow">
                <td class="col-6"></td>
                <td class="col-6"></td>
                <td class="col-3" style="display:none"></td>
                <td class="col-3"><span id="totalportfolio"></span><br><span style="color:grey;font-size:.7em;display:block;" id="totalportfoliosats"></span></td>
              </tr>
          </tfoot>
      </table>
  </div>
  <div id="wrapper" style="margin:0 auto;">
  <div id="container-pie" style="height:340px" class="col-md-6"></div>
  <div id="loader-pie" class="block-loader col-md-6 center">
    <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
  </div>
  <div class="wrapper-container-historical">
    <div class="dropdown-custom col-md-4 center" id="dropdown-historical-value" style="margin-top: 1em;display:none;">
      <select id="historical-value" style="margin-right:.5em;">
        <option value="24H">1 Day</option>
        <option value="1W">1 Week</option>
        <option value="1M">1 Month</option>
        <option value="3M">3 Months</option>
        <option value="ALL">All Time</option>
      </select>
      Portfolio historical <span id="portfolio-currency-title"></span> value
    </div>
    <div id="container-historical-value" style="height:340px" class="col-md-4"></div>
    <div id="loader-historical" class="block-loader col-md-4 center">
      <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
    </div>
  </div>
</div>
</div>
<div class="tooltip_templates">
    <span id="tooltip_nft"></span>
</div>
<script>

$(document).ready(function() {

  $('#sendSpinner').hide();

  // if session storage exist, get it, else set it
  if (localStorage.getItem('currency') !== 'null') {
    currency = localStorage.getItem('currency');
    if (localStorage.getItem('currency') == 'EUR') {
      currencysymbol = '€';
    } else if (localStorage.getItem('currency') == 'CAD') {
      currencysymbol = 'C$';
    } else if (localStorage.getItem('currency') == 'GBP') {
      currencysymbol = '£';
    } else if (localStorage.getItem('currency') == 'JPY') {
      currencysymbol = '¥';
    } else if (localStorage.getItem('currency') == 'AUD') {
      currencysymbol = 'A$';
    } else {
      currencysymbol = '$';
    }
  } else {
    currency = 'USD';
    currencysymbol = '$';
  }
  // adjust currency header based on existing currency setting
  document.getElementById("currency-header").innerHTML = currency + ' VALUE';
  // default loader/dropdown/chart values
  $("#historical-value").val('3M');
  $("#loader-pie").hide();
  $("#loader-historical").hide();
  $("#container-historical-value").hide();
  $(document.getElementById("count-soulmasters")).fadeTo("fast", 0);
  updatedKCALbalance = 0;
  amountsoulcombined = 0;
  amountkcalcombined = 0;
  amountgascombined = 0;
  amountneocombined = 0;
  amountgoaticombined = 0;
  hasKCAL = 0;
  onLoad = 1;
  GetPieChart();
  // init portfolio chart on 3M
  getPortfolioChart('3M')
  // get all three smart contract call
  getUnclaimed();
  getStake();
  GetSoulmastersDetails();
  initTables();

  var pathname = window.location.pathname;
  // on all pages except login and create, get all three smart contract call every 5 minute
  if (pathname != '/login' && pathname != '/create') {
    setInterval(function() {
      getUnclaimed();
      getStake();
      GetSoulmastersDetails();
    }, 300000);
  }

  loadedKCALbalance = 0;

  arrayNFT = '';
  arrayNFTFormatted = '';
  arrayNFTlength = 0;
  {{#each chainTokens}}
      {{#each Ids}}
      arrayNFTlength++
      {{/each}}
  {{/each}}
  for (i = 0; i < (arrayNFTlength/100); i++) {
    idList = 0;
    window['arrayNFT' + i] = '';
    {{#each chainTokens}}
        {{#each Ids}}
        idList++
        if (idList/100 >= i && idList/100 < (i+1)) {
            window['arrayNFT' + i] += '{{this}}' + ',';
        }
        {{/each}}
    {{/each}}
    window['arrayNFTFormatted' + i] = (window['arrayNFT' + i]).substring(0, (window['arrayNFT' + i]).length - 1)
  }

  {{#each holdings}}
    if ('{{Symbol}}' == 'KCAL') {
      hasKCAL = 1;
      loadedKCALbalance = '{{Amount}}';
    }
  {{/each}}

  // Trigger stake button on press enter
  var inputstake = document.getElementById("manageinput");
  inputstake.addEventListener("keyup", function(event) {
      if (event.keyCode === 13) {
          //event.preventDefault();
          document.getElementById("stakebutton").click();
      }
  });

  tooltipData = '';

  if (arrayNFTlength > 0) {

    var arrayNFTFormattedResultTotal = [];
    for (i = 0; i < (arrayNFTlength/100); i++) {
        arrayNFTFormattedResultTotal.push(getNFTIds(window['arrayNFTFormatted' + i]));
    }
    Promise.all(arrayNFTFormattedResultTotal)
    .then(data => {

      // reduce
      dataNFT = data.reduce(function(result, current) {
        return Object.assign(result, current);
      }, {});

      // temp map to array & add id to array
      dataNFT = $.map(dataNFT, function(value, index) { value.id = index; return value; });

      // double sort item & mint
      dataNFT.sort(function (a, b) {

      	if (a.item > b.item) return 1;
      	if (a.item < b.item) return -1;

      	if (a.mint > b.mint) return 1;
      	if (a.mint < b.mint) return -1;

      });

      // pre sort by item high first
      let byThis = 'item';
      let compare = (k, kk) => dataNFT[kk][byThis] - dataNFT[k][byThis];
      preSorteddataNFT = Object.keys(dataNFT).sort(compare);

      for (i = 0; i < preSorteddataNFT.length; i++) {

        rarity = '';
        mint = '';
        id = '';
        type = '';
        item = '';
        img = '';
        name = 'goati server error';

        if (dataNFT[preSorteddataNFT[i]].item_info) {
          if (dataNFT[preSorteddataNFT[i]].id) {
            id = dataNFT[preSorteddataNFT[i]].id;
          }
          if (dataNFT[preSorteddataNFT[i]].item_info.name_english) {
            name = (dataNFT[preSorteddataNFT[i]].item_info.name_english).replace('<br/>', ' • ');
          }
          if (dataNFT[preSorteddataNFT[i]].mint) {
            mint = dataNFT[preSorteddataNFT[i]].mint;
          }
          if (dataNFT[preSorteddataNFT[i]].item_info.rarity) {
            rarity = ' • ' + formatRarity(dataNFT[preSorteddataNFT[i]].item_info.rarity);
          }
          if (dataNFT[preSorteddataNFT[i]].item_info.display_type_english) {
            type = dataNFT[preSorteddataNFT[i]].item_info.display_type_english
          }
          if (dataNFT[preSorteddataNFT[i]].img) {
            img = dataNFT[preSorteddataNFT[i]].img
          } else {
            img = '/img/nft_notfound.png';
          }
          if (dataNFT[preSorteddataNFT[i]].item) {
            item = dataNFT[preSorteddataNFT[i]].item
          }
        }

        tooltipData += '<div style="width:7em;display:inline-block;text-align:center;margin-right:3em;"><div style="text-align:center;"><img style="height:70px;margin-bottom:.5em;" src="' + img + '?width=256" onerror="this.onerror=null;this.src=\'/img/nft_notfound.png\'"></div></div><a href="https://22series.com/part_info?id=' + id + '" target="_blank">' + name + ' • Mint #' + mint + ' • ' + type + rarity + '</a><br>'

      }

      document.getElementById("tooltip_nft").innerHTML = tooltipData;
      $('#tooltip_nft_list').show('fast');

      // init tooltipster i
      $('i.tooltip-nft').tooltipster({
        theme: 'tooltipster-noir',
        contentCloning: true,
        side: 'right',
        plugins: ['sideTip', 'scrollableTip'],
        interactive: true
      });

    })

    async function getNFTIds(arrayids) {

      let myPromise = new Promise((resolve, reject) => {

      $.ajax({
          xhrFields: {
              withCredentials: !1
          },
          cache: !1,
          crossDomain: !0,
          type: 'POST',
          dataType: 'json',
          data: JSON.stringify({ids: arrayids}),
          url: 'https://www.22series.com/api/store/nft',
          success: function(returnedDataTX) {
            var dataNFT = returnedDataTX;
            resolve(dataNFT);
          }
        })

      });

      let dataNFTdetail = await myPromise;
      return dataNFTdetail;

    }

  }

// function format rarity
function formatRarity(rarity) {

  switch(rarity)
  {
    case 1: return 'Consumer';
    case 2: return 'Industrial';
    case 3: return 'Professional';
    case 4: return 'Custom';
    case 5: return 'Collector';
    case 6: return 'Unique';
    default: return 'Unknown';
  }

}

});
// Datatable initialization
function initTables() {
    if (!$.fn.dataTable.isDataTable('#mainportfoliotable')) {
        setTimeout(function() {
            jQuery.extend(jQuery.fn.dataTableExt.oSort, {
              // custom ordering
                "currency-pre": function(a) {
                    a = (a === "-") ? 0 : a.replace(/[^\d\-\.]/g, "");
                    return parseFloat(a)
                },
                "currency-asc": function(a, b) {
                    return a - b
                },
                "currency-desc": function(a, b) {
                    return b - a
                }
            });
            $('#mainportfoliotable').DataTable({
                // start ordering on column 1
                "order": [
                    [3, "desc"]
                ],
                // adjust command and dot and replace default texts
                "language": {
                    "decimal": ".",
                    "thousands": ","
                },
                "bPaginate": !1,
                "aaSorting": [],
                // custom column defs
                "columnDefs": [{
                    type: 'currency',
                    targets: [3]
                }],
                // show datatable only after its fully initialized
                "initComplete": function() {
                    $(this).show()
                }
            })
        }, 100)
    }
}

// cosmic swap when low kcal balances
function cosmicSwapFixed() {

  params = [];
  // build params for contract swap 0.1 soul to kcal
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
  params[1] = { name: 'fromSymbol', type: 'String', input: 'SOUL', info: '' }
  params[2] = { name: 'toSymbol', type: 'String', input: 'KCAL', info: '' }
  params[3] = { name: 'amount', type: 'Number', input: '10000000', info: '' }
  var countercontract = 0;
  loopContract();
  function loopContract() {
    $("#wrapper-portfolio-confirm").fadeTo(1, 0);
    $.post('/cosmicfixed',
       function (returnedData) {
          //console.log(returnedData)
          document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
          $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
          if (returnedData !== "") {
            var counter = 0;
            getConfirmations();
            function getConfirmations() {
                  $.get('/tx/' + returnedData,
                      function (returnedDataTX) {
                        //console.log(returnedDataTX)
                        if ((JSON.parse(returnedDataTX).error) == 'pending') {
                            counter++;
                            if (counter <= 10){
                              setTimeout(getConfirmations, 2000);
                            } else {
                              window.location.replace("/error");
                            }
                        } else if ((JSON.parse(returnedDataTX).error) == 'Transaction not found') {
                            countercontract++;
                            if (countercontract <= 10){
                              setTimeout(loopContract, 2000);
                            } else {
                              window.location.replace("/error");
                            }
                        } else {
                          //window.location.replace("/waiting/" + returnedData);
                          setTimeout(function() {
                            window.location.replace("/portfolio");
                          }, 2000);
                        }
                  })
            }
        }
      }).fail(function(e) {
        $('#sendSpinner').hide();
        console.log(JSON.parse(JSON.stringify(e)).statusText)
        $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
            document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.parse((JSON.stringify(e))).statusText;
            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
        });
      });

  }

}

// on click claim on portfolio
function Claim() {

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
    bootbox.confirm({
        title: "Swap confirmation",
        message: "You don't have enough KCAL for this action (current balance: " + loadedKCALbalance + " KCAL).<br>Do you want to cosmic swap 0.1 SOUL? You'll get approximatively 0.5 KCAL for that.",
        buttons: {
            cancel: {
                label: '<i class="fa fa-times"></i> Cancel'
            },
            confirm: {
                label: '<i class="fa fa-check"></i> Confirm'
            }
        },
        callback: function(result) {

            if (result) {

              cosmicSwapFixed();

            }

        }
      })
      return;
  }

  $("#wrapper-portfolio-confirm").fadeTo(1, 0);
  var params = [];
  // calculate amount/changedamount/futureamount
  currentkcalamount = parseFloat((document.getElementById("KCAL-amount").innerHTML).replace(/\,/g,''));
  changedamount = parseFloat((document.getElementById("unclaimed-kcal").innerHTML.slice(0, -5)).replace(/\,/g,''));
  futureamount = currentkcalamount + changedamount;
  // build params for contract call
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
  params[1] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

  if (toFixed((changedamount)) == 0 || Number.isNaN(changedamount)) {
        bootbox.alert("Nothing to claim yet!");
        return;
  }

  $('#sendSpinner').show();

  $.post('/contract/tx',
     {
         chain: 'main',
         contract: 'stake',
         method: 'Claim',
         params: JSON.stringify({
           params
         })
     },
     function (returnedData) {
       //console.log(returnedData)
       // If /contract/tx works, call /tx/hash in a loop to check if the tx worked
       var counter = 0;
       getConfirmations();
       function getConfirmations() {

        $.get('/tx/' + returnedData,
            function (returnedDataTX) {
              //console.log(returnedDataTX)
              $('#sendSpinner').hide();
              if ((JSON.parse(returnedDataTX).error) == 'pending') {
                  counter++;
                  if (counter <= 6){
                    setTimeout(getConfirmations, 2000);
                  }
                  // If tx pending, returns the custom error message
                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
              } else {

                  if ((JSON.parse(returnedDataTX).error) != undefined) {
                    // If .error defined, returns the custom error message
                    $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                        document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction ' + (JSON.parse(returnedDataTX).error);
                        $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                    });
                  } else {
                    setTimeout(function() {
                      window.location.replace("/portfolio");
                    }, 2000);
                    // If it works, returns the tx link
                    $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                        document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction successful: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                        $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                    });
                  }

              }

            }).fail(function(e) {
              $('#sendSpinner').hide();
              console.log(JSON.stringify(e))
              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                  document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e);
                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
              });
            });
          }
     }).fail(function(e) {
       $('#sendSpinner').hide();
        console.log(JSON.stringify(e))
        $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
            document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e);
            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
        });
     })

}

// on click stake on portfolio
function Stake() {

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
    bootbox.confirm({
        title: "Swap confirmation",
        message: "You don't have enough KCAL for this action (current balance: " + loadedKCALbalance + " KCAL).<br>Do you want to cosmic swap 0.1 SOUL? You'll get approximatively 0.5 KCAL for that.",
        buttons: {
            cancel: {
                label: '<i class="fa fa-times"></i> Cancel'
            },
            confirm: {
                label: '<i class="fa fa-check"></i> Confirm'
            }
        },
        callback: function(result) {

            if (result) {

              cosmicSwapFixed();

            }

        }
      })
      return;
  }

  $("#wrapper-portfolio-confirm").fadeTo(1, 0);
  var params = [];
  // calculate amount/changedamount/futureamount
  if (document.getElementById("SOUL-amount")) {
    currentsoulamount = parseFloat((document.getElementById("SOUL-amount").innerHTML).replace(/\,/g,''));
  } else {
    currentsoulamount = 0;
  }
  if (localStorage.getItem('currency') == 'CAD' || localStorage.getItem('currency') == 'AUD') {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(2).replace(/\,/g,''));
  } else {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(1).replace(/\,/g,''));
  }
  changedamount = parseFloat(document.getElementById("manageinput").value);
  futureamount = currentsoulamount - changedamount;
  futuresoulprice = futureamount * currentsoulpriceunit;
  // build params for contract call
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
  params[1] = { name: 'stakeAmount', type: 'Number', input: toFixed((changedamount)*(Math.pow(10,8))), info: '' }

  if (Number.isNaN(changedamount)) {
        bootbox.alert("Please enter a SOUL amount to stake!");
        return;
  }

  if (toFixed(changedamount) < 2) {
        bootbox.alert("Minimum amount to stake is 2 SOUL!");
        return;
  }

  if (toFixed(changedamount > currentsoulamount)) {
        bootbox.alert("Not enough SOUL available!");
        return;
  }

  if (hasKCAL == 0) {
    custommessagecombined = '<br>Since you do not have any KCAL, a one-time KCAL claim will also be performed.';
  } else {
    custommessagecombined = '';
  }

  $('#sendSpinner').show();
  bootbox.confirm({
      title: "Staking confirmation",
      message: "Stake <strong>" +
          numberWithCommas(toFixed((changedamount))) +
          " SOUL?</strong><br>You will be able to claim " + toFixed((changedamount)*0.002) + " KCAL per day." +
          custommessagecombined,
      buttons: {
          cancel: {
              label: '<i class="fa fa-times"></i> Cancel'
          },
          confirm: {
              label: '<i class="fa fa-check"></i> Confirm'
          }
      },
      callback: function(result) {

        if (result) {

          if (document.getElementById("KCAL-amount")) {

            $.post('/contract/tx',
               {
                  chain: 'main',
                  contract: 'stake',
                  method: 'Stake',
                  params: JSON.stringify({
                    params
                  })
               },
               function (returnedData) {
                  //console.log(returnedData)
                  // If /contract/tx works, call /tx/hash in a loop to check if the tx worked
                  var counter = 0;
                  getConfirmations();
                  function getConfirmations() {

                  $.get('/tx/' + returnedData,
                      function (returnedDataTX) {
                        //console.log(returnedDataTX)
                        $('#sendSpinner').hide();
                        if ((JSON.parse(returnedDataTX).error) == 'pending') {
                            counter++;
                            if (counter <= 6){
                              setTimeout(getConfirmations, 2000);
                            }
                            // If tx pending, returns the custom error message
                            document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                        } else {

                          if ((JSON.parse(returnedDataTX).error) != undefined) {
                              // If .error defined, returns the custom error message
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction ' + (JSON.parse(returnedDataTX).error);
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                            } else {
                              //console.log(returnedDataTX)
                              if (updatedKCALbalance == 0) {
                                  $('#temp-kcal').hide();
                              }
                              setTimeout(function() {
                                window.location.replace("/portfolio");
                              }, 2000);
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction successful: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                            }

                          }

                      }).fail(function(e) {
                        $('#sendSpinner').hide();
                        console.log(JSON.stringify(e.statusText))
                        $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                            document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e.statusText);
                            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                        });
                      });

                    }

               }).fail(function(e) {
                  $('#sendSpinner').hide();
                  console.log(JSON.stringify(e.statusText))
                  $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                      document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e.statusText);
                      $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                  });
               })

               document.getElementById("manageinput").value = '';

          } else {

            $.post('/stake',
               {
                   stakeAmount: toFixed(changedamount*100000000)
               },
               function (returnedData) {
                 //console.log(returnedData)
                 // If /contract/tx works, call /tx/hash in a loop to check if the tx worked
                 var counter = 0;
                 getConfirmations();
                 function getConfirmations() {

                  $.get('/tx/' + returnedData,
                      function (returnedDataTX) {
                        //console.log(returnedDataTX)
                        $('#sendSpinner').hide();
                        if ((JSON.parse(returnedDataTX).error) == 'pending') {
                            counter++;
                            if (counter <= 6){
                              setTimeout(getConfirmations, 2000);
                            }
                            // If tx pending, returns the custom error message
                            document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                        } else {

                            if ((JSON.parse(returnedDataTX).error) != undefined) {
                              // If .error defined, returns the custom error message
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction ' + (JSON.parse(returnedDataTX).error);
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                            } else {
                              //console.log(returnedDataTX)
                              setTimeout(function() {
                                window.location.replace("/portfolio");
                              }, 2000);
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction successful: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                            }

                        }
                      }).fail(function(e) {
                        $('#sendSpinner').hide();
                        console.log(JSON.stringify(e.statusText))
                        $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                            document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e.statusText);
                            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                        });
                      });

                    }

               }).fail(function(e) {
                  $('#sendSpinner').hide();
                  console.log(JSON.stringify(e.statusText))
                  $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                      document.getElementById("wrapper-portfolio-confirm").innerHTML = JSON.stringify(e.statusText);
                      $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                  });
               })
               document.getElementById("manageinput").value = '';
             }
           } else {
             $('#sendSpinner').hide();
           }
         }
     })
}
// on click stake on portfolio
function Unstake() {

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
    bootbox.confirm({
        title: "Swap confirmation",
        message: "You don't have enough KCAL for this action (current balance: " + loadedKCALbalance + " KCAL).<br>Do you want to cosmic swap 0.1 SOUL? You'll get approximatively 0.5 KCAL for that.",
        buttons: {
            cancel: {
                label: '<i class="fa fa-times"></i> Cancel'
            },
            confirm: {
                label: '<i class="fa fa-check"></i> Confirm'
            }
        },
        callback: function(result) {

            if (result) {

              cosmicSwapFixed();

            }

        }
      })
      return;
  }

  $("#wrapper-portfolio-confirm").fadeTo(1, 0);
  customunstakeall = '';
  var params = [];
  // calculate amount/changedamount/futureamount
  if (document.getElementById("SOUL-amount")) {
    currentsoulamount = parseFloat((document.getElementById("SOUL-amount").innerHTML).replace(/\,/g,''));
  } else {
    currentsoulamount = 0;
  }
  if (localStorage.getItem('currency') == 'CAD' || localStorage.getItem('currency') == 'AUD') {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(2).replace(/\,/g,''));
  } else {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(1).replace(/\,/g,''));
  }
  changedamount = parseFloat(document.getElementById("manageinput").value);
  futureamount = currentsoulamount + changedamount;
  futuresoulprice = futureamount * currentsoulpriceunit;
  // build params for contract call
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }
  params[1] = { name: 'stakeAmount', type: 'Number', input: toFixed((changedamount)*(Math.pow(10,8))), info: '' }

  if (Number.isNaN(changedamount)) {
        bootbox.alert("Please enter a SOUL amount to unstake!");
        return;
  }

  if (toFixed(changedamount) < 1) {
        bootbox.alert("Minimum amount to unstake is 1 SOUL!");
        return;
  }

  if (toFixed(changedamount > parseFloat((document.getElementById("stake-soul").innerHTML).replace(/\,/g,'').slice(0, -3)))) {
        bootbox.alert("Not enough SOUL staked!");
        return;
  }

  if (toFixed(changedamount == parseFloat((document.getElementById("stake-soul").innerHTML).replace(/\,/g,'').slice(0, -3)))) {
        customunstakeall = '<br>You are trying to unstake all your SOUL. Doing so will unregister your name automatically if you have one.';
  }

  $('#sendSpinner').show();
  bootbox.confirm({
      title: "Unstaking confirmation",
      message: "Unstake <strong>" +
          numberWithCommas(toFixed((changedamount))) +
          " SOUL?</strong><br>This will decrease the amount of KCAL you can claim per day by " + toFixed((changedamount)*0.002) + " KCAL." + customunstakeall,
      buttons: {
          cancel: {
              label: '<i class="fa fa-times"></i> Cancel'
          },
          confirm: {
              label: '<i class="fa fa-check"></i> Confirm'
          }
      },
      callback: function(result) {

        if (result) {

          $.post('/contract/tx',
             {
                 chain: 'main',
                 contract: 'stake',
                 method: 'Unstake',
                 params: JSON.stringify({
                   params
                 })
             },
             function (returnedData) {
               //console.log(returnedData)
               // If /contract/tx works, call /tx/hash in a loop to check if the tx worked
               var counter = 0;
               getConfirmations();
               function getConfirmations() {

                $.get('/tx/' + returnedData,
                    function (returnedDataTX) {
                      //console.log(returnedDataTX)
                      $('#sendSpinner').hide();
                      if ((JSON.parse(returnedDataTX).error) == 'pending') {
                          counter++;
                          if (counter <= 6){
                            setTimeout(getConfirmations, 2000);
                          }
                          // If tx pending, returns the custom error message
                          document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                          $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                      } else {

                          if ((JSON.parse(returnedDataTX).error) != undefined) {
                              // If .error defined, returns the custom error message
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction ' + (JSON.parse(returnedDataTX).error) + '. This can only be done 24h after your last stake.';
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                          } else {
                              setTimeout(function() {
                                window.location.replace("/portfolio");
                              }, 2000);
                              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction successful: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                              });
                          }

                      }
                    }).fail(function(e) {
                      $('#sendSpinner').hide();
                      console.log(e)
                      $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                          document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
                          $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                      });
                    });
                  }
             }).fail(function(e) {
                $('#sendSpinner').hide();
                console.log(e)
                $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                    document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
                    $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                });
             })

             document.getElementById("manageinput").value = '';
         } else {
           $('#sendSpinner').hide();
         }
       }
     })
}
// on click claim rewards on portfolio
function MasterClaim() {

  if (parseFloat(loadedKCALbalance) < 0.1 && parseFloat(loadedKCALbalance) > 0) {
    bootbox.confirm({
        title: "Swap confirmation",
        message: "You don't have enough KCAL for this action (current balance: " + loadedKCALbalance + " KCAL).<br>Do you want to cosmic swap 0.1 SOUL? You'll get approximatively 0.5 KCAL for that.",
        buttons: {
            cancel: {
                label: '<i class="fa fa-times"></i> Cancel'
            },
            confirm: {
                label: '<i class="fa fa-check"></i> Confirm'
            }
        },
        callback: function(result) {

            if (result) {

              cosmicSwapFixed();

            }

        }
      })
      return;
  }

  var d = new Date();
  if (d.getDate() !== 1) {
    bootbox.alert("Can only be performed the first day of each month");
    return;
  }

  $("#wrapper-portfolio-confirm").fadeTo(1, 0);
  var params = [];
  // calculate amount/changedamount/futureamount
  if (document.getElementById("SOUL-amount")) {
    currentsoulamount = parseFloat((document.getElementById("SOUL-amount").innerHTML).replace(/\,/g,''));
  } else {
    currentsoulamount = 0;
  }
  if (localStorage.getItem('currency') == 'CAD' || localStorage.getItem('currency') == 'AUD') {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(2).replace(/\,/g,''));
  } else {
    currentsoulpriceunit = parseFloat((document.getElementById("soulprice").innerHTML).substr(1).replace(/\,/g,''));
  }
  // build params for contract call
  params[0] = { name: 'from', type: 'Object', input: '{{address}}', info: '' }

  if (document.getElementById("count-soulmasters-total").innerHTML == '0 SOULMASTER') {
        bootbox.alert("Nothing to claim yet!");
        return;
  }

  $('#sendSpinner').show();

  $.post('/contract/tx',
     {
         chain: 'main',
         contract: 'stake',
         method: 'MasterClaim',
         params: JSON.stringify({
           params
         })
     },
     function (returnedData) {
       //console.log(returnedData)
       // If /contract/tx works, call /tx/hash in a loop to check if the tx worked
       var counter = 0;
       getConfirmations();
       function getConfirmations() {

        $.get('/tx/' + returnedData,
            function (returnedDataTX) {
              //console.log(returnedDataTX)
              $('#sendSpinner').hide();
              if ((JSON.parse(returnedDataTX).error) == 'pending') {
                  counter++;
                  if (counter <= 6){
                    setTimeout(getConfirmations, 2000);
                  }
                  // If tx pending, returns the custom error message
                  document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction pending: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
              } else {

                if ((JSON.parse(returnedDataTX).error) != undefined) {
                  // If .error defined, returns the custom error message
                  $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                      document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction ' + (JSON.parse(returnedDataTX).error) + '. This can only be done after the 1st of each month.';
                      $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                  });
                } else {
                  setTimeout(function() {
                    window.location.replace("/portfolio");
                  }, 2000);
                  $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                      document.getElementById("wrapper-portfolio-confirm").innerHTML = 'Transaction successful: <a href="{{explorer}}/tx/' + returnedData + '" target="_blank" title="View Transaction">' + returnedData + '</a>';
                      $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
                  });
                }

            }
            }).fail(function(e) {
              $('#sendSpinner').hide();
              console.log(e)
              $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
                  document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
                  $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
              });
            });
          }
     }).fail(function(e) {
        $('#sendSpinner').hide();
        console.log(e)
        $('#wrapper-portfolio-confirm').fadeTo("fast", 0, function() {
            document.getElementById("wrapper-portfolio-confirm").innerHTML = e;
            $("#wrapper-portfolio-confirm").fadeTo("slow", 1);
        });
     })

     document.getElementById("manageinput").value = '';

}

// function getunclaimed kcal
function getUnclaimed() {

  var params = [];
  // build params for contract call
  params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

  $.post('/contract',
     {
         chain: 'main',
         contract: 'stake',
         method: 'GetUnclaimed',
         params: JSON.stringify({
           params
         })
     },
     function (returnedData) {
         // format kcal with decimals value
         unclaimedFormatted = (returnedData) / (Math.pow(10, 10));
         // if amount exist and changed, flash the value
         if (document.getElementById("unclaimed-kcal").innerHTML != numberWithCommas(unclaimedFormatted) + ' KCAL') {
           document.getElementById("unclaimed-kcal").innerHTML = numberWithCommas(toFixed(unclaimedFormatted)) + ' KCAL';
           $(document.getElementById("unclaimed-kcal")).addClass('flash-portfolio').delay(300).queue(function(next){
                $(this).removeClass('flash-portfolio');
                next();
           });
         }
         // if kcal value 0 disable button
         if (unclaimedFormatted == 0 || Number.isNaN(unclaimedFormatted)) {
           $(document.getElementById("claim-kcal")).addClass('button-disabled').delay(300).queue(function(next){
           });
         } else {
           $(document.getElementById("claim-kcal")).removeClass('button-disabled').delay(300).queue(function(next){
           });
         }
     }).fail(function(e) {
        console.log(e)
     })

}

// function getStake
function getStake() {

  var params = [];
  // build params for contract call
  params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

  $.post('/contract',
     {
         chain: 'main',
         contract: 'stake',
         method: 'GetStake',
         params: JSON.stringify({
           params
         })
     },
     function (returnedData) {
        // format soul with decimals value
        stakesFormatted = (returnedData) / (Math.pow(10, 8));
        // if amount exist and changed, flash the value
        if (document.getElementById("stake-soul").innerHTML != numberWithCommas(stakesFormatted) + ' SOUL') {
          document.getElementById("stake-soul").innerHTML = numberWithCommas(stakesFormatted) + ' SOUL';
          $(document.getElementById("stake-soul")).addClass('flash-portfolio').delay(300).queue(function(next){
               $(this).removeClass('flash-portfolio');
               next();
          });
        }
        // if kcal per day exist and changed, flash the value
        if (document.getElementById("rewards-kcal").innerHTML != numberWithCommas(parseFloat((stakesFormatted/500).toFixed(0))) + ' KCAL / DAY') {
          document.getElementById("rewards-kcal").innerHTML = numberWithCommas(parseFloat((stakesFormatted/500).toFixed(0))) + ' KCAL / DAY';
          $(document.getElementById("rewards-kcal")).addClass('flash-portfolio').delay(300).queue(function(next){
               $(this).removeClass('flash-portfolio');
               next();
          });
        }
        // if 0 soul staked hide unstake
        if (stakesFormatted == 0) {
          $("#unstake-soul").hide();
        } else {
          $("#unstake-soul").show();
        }
     }).fail(function(e) {
        console.log(e)
     })

}

// function GetSoulmastersDetails
function GetSoulmastersDetails() {

  var params = [];
  var params2 = [];
  var params3 = [];
  var d = new Date();

  if (d.getMonth().toString().length < 2) {
    customMonth = '0' + parseFloat(d.getMonth() + 2);
  } else if (d.getMonth() == '10') {
    customMonth = 12
  } else if (d.getMonth() == '11') {
    customMonth = '01'
  }

  // call both GetMasterCount and GetStake for calculations
  $.when(

    $.post('/contract',
       {
           chain: 'main',
           contract: 'stake',
           method: 'GetMasterCount',
           params: JSON.stringify({
             params
           })
       },
       function (returnedData) {
          mastertotalcount = returnedData;
       }).fail(function(e) {
          console.log(e)
       }),

     // build params for contract call
     params2[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' },

     $.post('/contract',
        {
            chain: 'main',
            contract: 'stake',
            method: 'GetStake',
            params: JSON.stringify({
              params2
            })
        },
        function (returnedData) {
           stakeamount = returnedData;
        }).fail(function(e) {
           console.log(e)
        }),

        // build params for contract call
        params3[0] = { name: 'claimDate', type: 'Timestamp', input: customMonth + '/02/2020 00:00:00', info: '' },

        $.post('/contract',
           {
               chain: 'main',
               contract: 'stake',
               method: 'GetClaimMasterCount',
               params: JSON.stringify({
                 params3
               })
           },
           function (returnedData) {
              mastertotalcounteligible = returnedData;
           }).fail(function(e) {
              console.log(e)
           })

     ).then(function() {
       // check if address is master
       if (stakeamount/(Math.pow(10,8)) >= 50000) {
         mastercount = 1;
       } else {
         mastercount = 0;
       }
       // calculate total soulmasters
       if (mastertotalcounteligible > 0) {
         rewards = 125000/mastertotalcounteligible;
       } else {
         rewards = 0;
       }
       // if soulmaster exist and changed, flash the value
       if (mastercount != 0) {
         document.getElementById("count-soulmasters").innerHTML = '<img class="status-icon" src="img/soulmasterstatus_logo.png" />';
         $(document.getElementById("count-soulmasters")).fadeTo("slow", 1);
       }
       // if amount 0 or 1 total soulmaster exist and changed, flash the value
       if (mastertotalcount == 0 || mastertotalcount == 1) {
         if (document.getElementById("count-soulmasters-total").innerHTML != mastertotalcount + ' SOULMASTER') {
           document.getElementById("count-soulmasters-total").innerHTML = mastertotalcount + ' SOULMASTER';
           $(document.getElementById("count-soulmasters-total")).addClass('flash-portfolio').delay(300).queue(function(next){
                $(this).removeClass('flash-portfolio');
                next();
           });
         }
       } else {
         // if amount >1 total soulmaster exist and changed, flash the value
         if (document.getElementById("count-soulmasters-total").innerHTML != mastertotalcount + ' SOULMASTERS') {
           document.getElementById("count-soulmasters-total").innerHTML = mastertotalcount + ' SOULMASTERS';
           $(document.getElementById("count-soulmasters-total")).addClass('flash-portfolio').delay(300).queue(function(next){
                $(this).removeClass('flash-portfolio');
                next();
           });
         }
       }
       // if amount rewards soulmaster exist and changed, flash the value
       if (document.getElementById("eligible-soulmasters").innerHTML != numberWithCommas(parseFloat((mastertotalcounteligible))) + ' Eligible / ') {
         document.getElementById("eligible-soulmasters").innerHTML = numberWithCommas(parseFloat((mastertotalcounteligible)))  + ' Eligible / ';
         $(document.getElementById("eligible-soulmasters")).addClass('flash-portfolio').delay(300).queue(function(next){
              $(this).removeClass('flash-portfolio');
              next();
         });
       }
       // if amount rewards soulmaster exist and changed, flash the value
       if (document.getElementById("rewards-soulmasters").innerHTML != numberWithCommas(parseFloat((rewards).toFixed(0))) + ' SOUL PER SM') {
         document.getElementById("rewards-soulmasters").innerHTML = numberWithCommas(parseFloat((rewards).toFixed(0))) + ' SOUL PER SM';
         $(document.getElementById("rewards-soulmasters")).addClass('flash-portfolio').delay(300).queue(function(next){
              $(this).removeClass('flash-portfolio');
              next();
         });
       }
       // if getstake < 50000 disable claim rewards button
       if (mastercount == 0 || mastertotalcount == 0 || mastertotalcounteligible == 0) {
         $(document.getElementById("claim-rewards")).addClass('button-disabled').delay(300).queue(function(next){
         });
       } else {
         var d = new Date();
         if (d.getDate() == '1') {
           $(document.getElementById("claim-rewards")).removeClass('button-disabled').delay(300).queue(function(next){
           });
         }
       }
     })

}

// function getPortfolioChart based on timeframe
function getPortfolioChart(timeframe) {

  $("#loader-historical").show();

  // start url pricing
  urlforcombined = 'https://api.o3.network/v1/price/SOUL?source=cryptocompare&currency=' + currency;
  arraygraph = [];
  params = [];
  // build params for contract call
  params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }

  // call both GetUnclaimed and GetStake for calculations
  $.when(

  $.post('/contract',
     {
         chain: 'main',
         contract: 'stake',
         method: 'GetStake',
         params: JSON.stringify({
           params
         })
     },
     function (returnedData) {
        // format soul based on decimals
        stakesFormatted = (returnedData) / (Math.pow(10, 8));

     }
   ).fail(function(e) {
      console.log(e)
      $("#loader-historical").hide();
   }),
   $.post('/contract',
      {
          chain: 'main',
          contract: 'stake',
          method: 'GetUnclaimed',
          params: JSON.stringify({
            params
          })
      },
      function (returnedData) {
         // format kcal based on decimals
         unclaimedFormatted = (returnedData) / (Math.pow(10, 10));

      }
    ).fail(function(e) {
       console.log(e)
    })

  ).then(function() {
    // loop over holdings to build url pricing
    {{#each holdings}}

      if ('{{Symbol}}' == 'SOUL') {
        amountsoulcombined = {{Amount}} + stakesFormatted
      }

      if (!document.getElementById("SOUL-amount") && stakesFormatted != 0) {
        amountsoulcombined = stakesFormatted
      }

      if ('{{Symbol}}' == 'KCAL') {
        amountkcalcombined = ({{Amount}} + unclaimedFormatted)/5
      }

      if ('{{Symbol}}' == 'GOATI') {
        amountgoaticombined = {{Amount}}
      }

    {{/each}}
        $.ajax({
            xhrFields: {
                withCredentials: !1
            },
            cache: !1,
            crossDomain: !0,
            type: 'GET',
            dataType: 'json',
            data: {},
            // final url pricing
            url: urlforcombined.replace(/\,/g,'') + '&i=' + timeframe,
            success: function(data) {
                var response = JSON.stringify(data);
                var parsedJson = JSON.parse(response);
                var positivebal = false;
                var ohlc = [],
                    dataLength = parsedJson.result.data.data.length,
                    i = dataLength - 1;
                for (i; i >= 0; --i) {
                    ohlc.push([
                        (new Date(parsedJson.result.data.data[i].time).getTime()),
                        (parsedJson.result.data.data[i].averageUSD) * (amountsoulcombined + amountkcalcombined) + (amountgoaticombined * 0.1)
                    ]);
                    positivebal = true;
                }
                if (positivebal == true) {
                  Highcharts.stockChart('container-historical-value', {
                      chart: {
                          style: {
                              fontFamily: 'Rubik'
                          }
                      },
                      xAxis: {
                        type: 'datetime',
                        labels: {
                          formatter: function() {
                            return Highcharts.dateFormat('%e %b', this.value);
                          },
                        }
                      },
                      yAxis: {
                          labels: {
                              formatter: function() {
                                  return currencysymbol + this.axis.defaultLabelFormatter.call(this);
                              }
                          },
                          opposite: false,
                          min: 0,
                          gridLineWidth: 0,
                          minorGridLineWidth: 0
                      },
                      navigator: {
                          enabled: false
                      },
                      scrollbar: {
                          enabled: false
                      },
                      rangeSelector: {
                          enabled: false
                      },
                      legend: {
                          enabled: false
                      },
                      credits: {
                          enabled: false
                      },
                      exporting: {
                          enabled: false
                      },
                      plotOptions: {
                          area: {
                              fillColor: {
                                  linearGradient: {
                                      x1: 0,
                                      y1: 0,
                                      x2: 0,
                                      y2: 1
                                  },
                                  stops: [
                                      [0, '#17B0E7'],
                                      [1, '#fff']
                                  ]
                              },
                              marker: {
                                  radius: 4
                              },
                              lineWidth: 3,
                              states: {
                                  hover: {
                                      lineWidth: 1
                                  }
                              },
                              threshold: null
                          }
                      },
                      tooltip: {
                          shared: true,
                          split: false,
                          formatter: function() {
                              if (($("#historical-value").val()) == '24H') {
                                var s = Highcharts.dateFormat('%A, %b %d, %Y - %H:%M', this.x);
                              } else {
                                var s = Highcharts.dateFormat('%A, %b %d, %Y', this.x);
                              }
                              $.each(this.points, function(i, point) {
                                  s += '<br/><span style="color:' + point.color + '">\u25CF</span> ' + point.series.name + ' <b>' + currencysymbol + Highcharts.numberFormat(point.y, 2, '.', ',') + '</b>';
                              });
                              return s;
                          }
                      },
                      series: [{
                          type: 'area',
                          name: 'Average Wallet Value:',
                          data: ohlc,
                          color: '#17B0E7',
                          fillColor: {
                              linearGradient: {
                                  x1: 1,
                                  y1: 1,
                                  x2: 1,
                                  y2: 1
                              },
                              stops: [
                                  [0, '#fff'],
                                  [1, '#fff']
                              ]
                          }
                      }],
                      title: {
                          text: '',
                          style: {
                              fontSize: '1em'
                          }
                      }
                  });
                  $("#loader-historical").hide();
                  // show portfolio graph
                  $("#container-historical-value").fadeIn(100);
                  // change dropdown balue based on timeframe selected
                  $("#historical-value").val(timeframe);
                  $("#dropdown-historical-value").fadeIn(100);
                  // add currency to graph title
                  document.getElementById("portfolio-currency-title").innerHTML = currency;
                } else {
                  $("#loader-historical").hide();
                }
            },
            error: function(xhr, err) {
              console.log(err);
              $("#loader-historical").hide();
            }
          });

  })

}
//function GetPieChart
function GetPieChart(changedamount) {

    $("#loader-pie").show();
    $("#container-pie").hide();
    valueTOTAL = 0;
    valueTOTALWithoutStakes = 0;
    arraygraph = [];
    params = [];
    // build params for contract call
    params[0] = { name: 'stakeAddress', type: 'Object', input: '{{address}}', info: '' }
    // call both GetUnclaimed and GetStake for calculations
    $.when(

    $.post('/contract',
       {
           chain: 'main',
           contract: 'stake',
           method: 'GetStake',
           params: JSON.stringify({
             params
           })
       },
       function (returnedData) {
          // format soul based on decimals
          stakesFormatted = (returnedData) / (Math.pow(10, 8));

       }
     ).fail(function(e) {
        console.log(e)
     }),
     $.post('/contract',
        {
            chain: 'main',
            contract: 'stake',
            method: 'GetUnclaimed',
            params: JSON.stringify({
              params
            })
        },
        function (returnedData) {
           // format kcal based on decimals
           unclaimedFormatted = (returnedData) / (Math.pow(10, 10));

        }
      ).fail(function(e) {
         console.log(e)
         $("#loader-pie").hide();
      })

    ).then(function() {
      // add stakes to holdings
      if (localStorage.getItem('currency') == 'CAD' || localStorage.getItem('currency') == 'AUD') {
        currentsoulprice = parseFloat((document.getElementById("soulprice").innerHTML).substr(2).replace(/\,/g,''));
      } else {
        currentsoulprice = parseFloat((document.getElementById("soulprice").innerHTML).substr(1).replace(/\,/g,''));
      }
      stakesPrice = currentsoulprice * stakesFormatted;
      // loop over holdings to build value total
      {{#each holdings}}
        if ('{{Symbol}}' == 'SOUL' || '{{Symbol}}' == 'KCAL' || '{{Symbol}}' == 'GOATI' || '{{Symbol}}' == 'GAS' || '{{Symbol}}' == 'NEO') {
          valueTOTAL += parseInt(('{{Price}}').replace(/,/g, ''));
          valueTOTALWithoutStakes += parseInt(('{{Price}}').replace(/,/g, ''));
        }
      {{/each}}
      if (stakesPrice != 0) {
        valueTOTAL += parseInt(stakesPrice);
      }
      // loop over holdings to build array for pie data
      {{#each holdings}}
        if ('{{Symbol}}' == 'SOUL' || '{{Symbol}}' == 'KCAL' || '{{Symbol}}' == 'GOATI' || '{{Symbol}}' == 'GAS' || '{{Symbol}}' == 'GAS') {
          arraygraph.push({name: "{{Symbol}}", y: ({{Price}})/valueTOTAL, oldColor: "#E8E8E8", sliced: true})
        }
      {{/each}}
      // add stakes to array
      if (stakesPrice != 0) {
        arraygraph.push({name: "SOUL - stakes", y: (stakesPrice)/valueTOTAL, oldColor: "#E8E8E8", sliced: true})
      }
      // add total portfolio once calculated
      document.getElementById("totalportfolio").innerHTML = currencysymbol + numberWithCommas(valueTOTALWithoutStakes.toFixed(0));
      // Handle price difference and rounding issue
      if (document.getElementById("SOUL-amount")) {
        currentsoulamount = parseFloat((document.getElementById("SOUL-amount").innerHTML).replace(/\,/g,''));
      } else {
        currentsoulamount = 0;
      }
      if ((valueTOTALWithoutStakes/currentsoulprice) < currentsoulamount) {
        document.getElementById("totalportfoliosats").innerHTML =  numberWithCommas(currentsoulamount) + ' SOUL';
      } else {
        document.getElementById("totalportfoliosats").innerHTML =  numberWithCommas((valueTOTALWithoutStakes/currentsoulprice).toFixed(0)) + ' SOUL';
      }

    Highcharts.chart('container-pie', {
      chart: {
          type: 'pie',
          style: {
              fontFamily: 'Rubik'
          }
      },
      credits: {
          enabled: !1
      },
      tooltip: {
          pointFormat: '{series.name}: <b>{point.percentage:.2f}%</b>'
      },
      plotOptions: {
          pie: {
              allowPointSelect: !0,
              cursor: 'pointer',
              depth: 30,
              colors: ['#17B0E7', '#E8E8E8', '#2f7ed8', '#434348', '#8bbc21', '#64E572', '#DDDF00', '#8085e9', '#f28f43', '#e4d354', '#f45b5b', '#77a1e5'],
              slicedOffset: 10,
              dataLabels: {
                  enabled: !0,
                  format: '{point.name}: {point.percentage:.2f} %',
                  style: {
                      textOutline: !1
                  }
              },
              states: {
                  hover: {
                      enabled: !1
                  },
                  inactive: {
                      opacity: 1
                  }
              },
              point: {
                  events: {
                      mouseOver: function() {
                          this.options.oldColor = this.color;
                          this.graphic.attr("fill", "#17B0E7");
                          var point = this,
                              points = this.series.points;
                          for (var key in points) {
                              if (points[key].sliced) {
                                  points[key].slice(!1)
                              }
                          }
                          if (!point.selected) {
                              point.slice(!0)
                          }
                      },
                      mouseOut: function() {
                          this.graphic.attr("fill", this.options.oldColor);
                          for (var key in this.points) {
                              if (this.points[key].sliced) {
                                  this.points[key].slice(!1)
                              }
                          }
                      }
                  }
              }
          }
      },
      series: [{
          title: 'Portfolio composition',
          type: 'pie',
          name: 'Portfolio',
          data: arraygraph
      }],
      title: {
          text: 'Portfolio composition',
          //text: '',
          style: {
              fontSize: '14px'
          }
      }
  })

  $("#loader-pie").hide();
  $("#container-pie").fadeIn(100);

  if (valueTOTAL == 0 || Number.isNaN(valueTOTAL)) {
    $("#container-pie").hide();
    $(document.getElementById("container-historical-value")).addClass('ml33p')
    $(document.getElementById("dropdown-historical-value")).addClass('ml33p')
  }

  }).fail(function(e) {
     console.log(e)
     $("#container-pie").hide();
  })

}

// Handles historical-value change
$("#historical-value").change(function() {

  $("#container-historical-value").hide();
  getPortfolioChart($("#historical-value").val())

})

</script>
{{#else}}
<div class="alert alert-info" role="alert" id="portfolionewaccount">
    This address is still new and does not have any assets yet.
</div>

{{/if}}
