<h3 class="tab-title">Swap assets</h3>

<div class="swap">
    <div id="sendSpinner" class="loading">Loading&#8230;</div>
    <div style="font-size:2em;display:flex;justify-content: center;">
      <span style="margin:1em;display:inline-block;" id="chainswap" class="highlighted">Chain Swap</span>
      <div style="margin-top:1em;display:inline-block;">
        <input class="tgl tgl-flat" id="cb4" type="checkbox" onclick="toggleSwap()">
        <label class="tgl-btn" style="margin: 0 auto;" for="cb4"></label>
      </div>
      <span style="margin:1em;display:inline-block;" id="cosmicswap">Cosmic Swap</span>
    </div>
    <div id="chainswapdiv" class="container" style="margin-top:0">
      <div id="chainswapdesc" style="margin:1em 1em 2em 1em;font-style:italic;color:#17B0E7;display:inline-block;font-size:1.2em;">From NEO Blockchain to Phantasma Blockchain</div>
      <i style="display:inline-block;font-size: 1.5em;" class="fas fa-sync" onclick="toggleChains()"></i>
      <div id="neotophantasma">
          <div class="row setup-content" id="step-2" style="display:none;">
              <div class="col-xs-12">
                  <div class="col-md-12">
                      <div class="alert alert-warning" style="overflow: auto;">
                          Do NOT send assets from an exchange wallet.<br>
                          Please send assets from the same <strong> personal wallet only</strong>!
                      </div>
                      <div id="loader-interopaddress" class="block-loader center">
                        <div class="lds-roller"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
                      </div>
                      <h4 class="control-label">Step 1) Send NEO, GAS or SOUL</h4>
                      <div class="center">
                          <p class="public-address" style="display:inline-block;">
                              <em><span id="currentplatformaddress"></span></em>
                          </p>
                          <span id="padcurrentplatformaddress" class="copy-pad" style="font-size: 20px;">
                            <a href="#">
                                <i class="fas fa-copy"></i>
                            </a>
                          </span>
                      </div>
                   </div>
               </div>
          </div>
          <div class="row setup-content" id="step-2" style="display:none;">
              <div class="col-xs-12">
                  <div class="col-md-12">
                      <h4 class="control-label">Step 2) Enter transaction hash</h4>
                      <input type="search" class="form-control parameters-swap-input" id="neohash" style="text-align:center;" placeholder="Enter transaction hash">
                  </div>
              </div>
          </div>
          <div class="row setup-content" id="step-3" >
              <div class="col-xs-12">
                  <div class="col-md-12">
                      <div>
                          <h4 class="control-label">Step 3) Select token</h4>
                          <select id="select-token-swap">
                              <option value="SOUL">SOUL</option>
                              <option value="NEO">NEO</option>
                              <option value="GAS">GAS</option>
                          </select>
                          <h4 class="control-label">Step 4) Sign with your NEO wallet</h4>
                          <div id="keytypetoggle" style="margin:.5em;font-style:italic;color:#17B0E7;display:inline-block;">Private Key</div>
                          <i style="display:inline-block;" class="fas fa-sync fa-sync-neo" onclick="toggleKeyType()"></i>
                          <input type="search" class="form-control parameters-swap-input" id="neoprivatekey" style="text-align:center;" placeholder="Enter NEO key">
                          <input type="search" class="form-control parameters-swap-input" id="neopassphrase" style="text-align:center;margin-top:1em;display:none;" placeholder="Enter NEO passphrase">
                          <button class="btn-primary nextBtn btn-lg button" type="button" onclick="swapNEOToPhantasma()" id="neotophantasmabutton">SWAP ASSETS</button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      <div id="phantasmatoneo" style="display:none;">
            <div class="row setup-content">
                <div class="col-xs-12">
                    <div class="col-md-12">
                      <div class="alert alert-warning" style="overflow: auto;">
                          Do NOT send assets from an exchange wallet.<br>
                          Please send assets from the same <strong> personal wallet only</strong>!
                      </div>
                      <h4 class="control-label">Step 1) Enter NEO address</h4>
                      <input class="form-control parameters-swap-input" id="neoaddress" type="text" style="text-align:center;" placeholder="Enter NEO address">
                      <h4 class="control-label" style="margin-top:1em;">Step 2) Select token</h4>
                      <select id="select-token-form"></select>
                      <h4 class="control-label" style="margin-top:1em;">Step 3) Enter amount</h4>
                      <input class="form-control parameters-swap-input" id="neoamount" type="number" style="text-align:center;" placeholder="Enter amount">
                      <button class="btn-success btn-lg button" type="button" onclick="swapPhantasmaToNEO()" id="phantasmatoneobutton">SWAP ASSETS</button>
                    </div>
                </div>
            </div>
      </div>
    </div>
</div>
<div id="cosmicswapdiv" class="container" style="margin-top:1em;display:none;">
  <h4>Not available yet, coming soon!</h4>
</div>

<script>

    $(document).ready(function () {

        $('#sendSpinner').hide();
        $("#loader-interopaddress").show();

        let tokenBox = $('#select-token-form');
        tokenBox.find('option').remove();

        {{#each chainTokens}}
        if ('{{Symbol}}' == 'SOUL' || '{{Symbol}}' == 'NEO' || '{{Symbol}}' == 'GAS') {
          formatedAmount = numberWithCommas('{{Amount}}');
          tokenBox.append($('<option>', {value:'{{Symbol}}', text:'{{Name}} ({{Symbol}}) - ' + formatedAmount}));
        }
        {{/each}}

        $.get('/platforms/',
            function (returnedDataPlatforms) {
              //console.log(returnedDataPlatforms)
              var pLength = (JSON.parse(returnedDataPlatforms)).length,
                  dstaddress = '',
                  i = 0;
              for (i; i < pLength; i += 1) {
                if (JSON.parse(returnedDataPlatforms)[i].platform == 'neo') {
                  dstaddress = JSON.parse(returnedDataPlatforms)[i].address
                }
              }
              document.getElementById("currentplatformaddress").innerHTML = dstaddress;
              document.getElementById("padcurrentplatformaddress").addEventListener('click', function(){ copyText(dstaddress, 'Address');}, false);
              $("#loader-interopaddress").hide();
              $("#step-2").show();
              $("#step-3").show();
            })

        // Trigger update button on press enter
        var inputrpc = document.getElementById("neoamount");
        inputrpc.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                //event.preventDefault();
                document.getElementById("phantasmatoneobutton").click();
            }
        });

        // Trigger update button on press enter
        var inputneoprivatekey = document.getElementById("neoprivatekey");
        inputneoprivatekey.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                //event.preventDefault();
                document.getElementById("neotophantasmabutton").click();
            }
        });

    })

    function swapPhantasmaToNEO() {

      let target_address_neo = $("#neoaddress").val();
      let token = $("#select-token-form").val();
      let amount = $("#neoamount").val().replace(/\,/g,'');

      if (target_address_neo == '') {
          bootbox.alert("Please enter a NEO address!");
          return;
      }

      if (target_address_neo.length !== 34) {
          bootbox.alert("Please enter a valid NEO address!");
          return;
      }

      if (token == null) {
          bootbox.alert("No assets available!");
          return;
      }

      if (toFixed((amount)) == 0 || Number.isNaN(amount)) {
          bootbox.alert("Please insert a valid amount!");
          return;
      }

      $('#sendSpinner').show();
      bootbox.confirm({
          title: "Swap confirmation",
          message: "Swap <strong>" +
              numberWithCommas(amount) +
              " " +
              token +
              "</strong> from Phantasma Blockchain to NEO Blockchain address <strong>" +
              target_address_neo +
              "</strong>?",
          buttons: {
              cancel: {
                  label: '<i class="fa fa-times"></i> Cancel'
              },
              confirm: {
                  label: '<i class="fa fa-check"></i> Confirm'
              }
          },
          callback: function(result) {

            if (result) {
              $.post('/sendrawtx',
                  {
                      fungible: 'True', token: token, amount: amount, dest: target_address_neo, chain: 'main' , destChain: 'main'
                  },
                  function (returnedData) {
                    if (returnedData !== "") {
                        window.location.replace("/waiting/" + returnedData);
                    } else {
                        window.location.replace("/error");
                    }
                    //console.log(returnedData);
                  })
                  .fail(function(e) {
                    console.log(JSON.stringify(e.statusText))
                  })
              }
              $('#sendSpinner').hide();
          }
      });

    }

    function swapNEOToPhantasma() {

      let hash = $("#neohash").val();
      let neokey = $("#neoprivatekey").val();
      let neopassphrase = $("#neopassphrase").val();
      let assetsymbol = $("#select-token-swap").val();

      if (!hash.length == 64) {
          bootbox.alert("Please insert a valid transaction hash!");
          return;
      }

      if (!neokey.length == 52 || !neokey.length == 58) {
          bootbox.alert("Please insert a valid private key or encrypted key!");
          return;
      }

      $('#sendSpinner').show();
      bootbox.confirm({
          title: "Swap confirmation",
          message: "Validate <strong>" +
              hash +
              "</strong><br>from NEO Blockchain and release <strong>" + assetsymbol + " on Phantasma Blockchain" +
              "</strong>?",
          buttons: {
              cancel: {
                  label: '<i class="fa fa-times"></i> Cancel'
              },
              confirm: {
                  label: '<i class="fa fa-check"></i> Confirm (personal wallet only, no exchange!)'
              }
          },
          callback: function(result) {

            if (result) {

              $.post('/settle/tx',
                 {
                     neoTxHash: hash,
                     neoKey: neokey,
                     neoPassphrase: neopassphrase,
                     assetSymbol: assetsymbol
                 },
                 function (returnedData) {
                   if (returnedData !== "") {
                       window.location.replace("/waiting/" + returnedData);
                   } else {
                       window.location.replace("/error");
                   }
                   //console.log(returnedData);
                 }
               ).fail(function(e) {
                 console.log(JSON.stringify(e.statusText))
               })

             }
             $('#sendSpinner').hide();
           }
        });

    }

</script>
